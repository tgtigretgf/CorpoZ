<!doctype html><html lang="pt-br"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><title>Corpo — v9 • Universo Vivo</title><style> :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; } * { box-sizing: border-box; } body { margin:0; background:#0b0b10; color:#e6e6ea; } header { padding:14px 16px; background:#101018; border-bottom:1px solid #23232d; position:sticky; top:0; z-index:20; } .title { font-weight:800; font-size:18px; letter-spacing:0.4px; } .sub { color:#9aa3b2; font-size:12px; } .container { padding:16px; max-width:1200px; margin:0 auto; } .card { background:#11121a; border:1px solid #23232d; border-radius:12px; padding:16px; margin-bottom:16px; } .btn { display:inline-block; padding:10px 12px; border-radius:10px; border:1px solid #2f2f3a; background:#191a22; color:#fff; cursor:pointer; } .btn:active { transform: scale(0.98); } .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; } .grid { display:grid; gap:12px; grid-template-columns:repeat(2, 1fr); } @media (min-width:900px){ .grid { grid-template-columns:repeat(3, 1fr);} } .choice { padding:12px; border:1px solid #2b2b36; border-radius:10px; background:#171a24; cursor:pointer; } .choice:hover { background:#1d2030; } .pill { border:1px solid #2f2f3a; border-radius:999px; padding:6px 10px; font-size:12px; color:#cbd5e1; } .small { font-size:12px; color:#9aa3b2; } .muted { color:#9aa3b2; } .log { white-space:pre-wrap; line-height:1.5; } .cols { display:grid; grid-template-columns:1fr; gap:16px; } @media (min-width:1140px){ .cols { grid-template-columns: 2fr 1fr; } } input[type="text"], input[type="password"], select { flex:1; padding:10px; border-radius:10px; border:1px solid #2f2f3a; background:#0f1118; color:#fff; } canvas, img { width:100%; border-radius:8px; border:1px solid #2b2b36; background:#0e0f14; } .avatar-card { display:flex; gap:10px; align-items:center; } .avatar-card img { width:64px; height:64px; object-fit:cover; border-radius:10px; } .hr { height:1px; background:#23232d; margin:10px 0; } .gallery { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; } @media (min-width:860px){ .gallery { grid-template-columns: repeat(3, 1fr); } } </style></head><style id="v24CSS">
#fpsPanel{ position:fixed; left:8px; bottom:8px; background:#0b0e16; border:1px solid #2a3150; border-radius:10px; padding:6px 8px; font-size:12px; color:#cfe1ff; z-index:99990;}
#installPWA{ position:fixed; top:8px; left:8px; background:#0b0e16; border:1px solid #2a3150; border-radius:10px; padding:8px 10px; font-size:12px; color:#cfe1ff; z-index:99996; display:none;}
#installPWA button{ margin-left:8px; }
html, body { overscroll-behavior-y: none; touch-action: manipulation; }
</style><style id="v23CSS">
#welcomeBanner{ position:fixed; top:8px; right:8px; background:#0b0e16; border:1px solid #2a3150; border-radius:12px; padding:8px 12px; z-index:99995; font-size:13px; color:#cfe1ff; }
#saveBadge{ position:fixed; bottom:42px; right:8px; background:#0b0e16; border:1px solid #2a3150; border-radius:12px; padding:6px 10px; z-index:99986; font-size:12px; color:#b8c2ea;}
</style><style id="v22CSS">
#npcCatalog{position:fixed; left:8px; bottom:8px; right:8px; top:64px; background:#0b0e16; border:1px solid #2a3150; border-radius:12px; padding:10px; display:none; z-index:99980; overflow:auto;}
#npcGrid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap:10px;}
.npcCard{ background:#121828; border:1px solid #2a3150; border-radius:10px; padding:8px; display:flex; flex-direction:column; gap:6px;}
.npcCard img{ width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; }
.npcMeta{ font-size:12px; color:#b8c2ea; display:flex; flex-direction:column; gap:2px;}
.badge{ display:inline-block; padding:1px 6px; border-radius:8px; border:1px solid #3b4672; font-size:11px; }
.row{ display:flex; gap:6px; align-items:center; justify-content:space-between; }
.btnTiny{ font-size:12px; padding:4px 6px; }
#btnNPC{ margin-left:6px; }
#statesBar{ position:fixed; left:8px; top:64px; display:flex; gap:8px; z-index:99970; }
.statePill{ background:#121828; border:1px solid #2a3150; border-radius:999px; padding:4px 10px; font-size:12px; color:#dfe6ff;}
#audioBadge{ position:fixed; right:8px; bottom:8px; background:#121828; border:1px solid #2a3150; border-radius:10px; padding:6px 8px; font-size:12px; color:#b8c2ea; z-index:99985;}
</style><style>
#introOverlay{ position:fixed;inset:0;background:#0b0b0e;display:flex;align-items:center; justify-content:center;flex-direction:column;color:#e9e9f1;z-index:99999; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px;
}
#introOverlay h1{font-size:28px;margin:6px 0 12px 0;letter-spacing:.5px}
#introOverlay p{max-width:680px;text-align:center;opacity:.9;line-height:1.4}
#introOverlay button{margin-top:18px;padding:12px 18px;border:0;border-radius:8px;cursor:pointer}
#introOverlay small{opacity:.65;margin-top:10px}
#tlChooser{margin-top:12px}
</style><style>
#sheetModal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:99998}
#sheetCard{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%); width: min(92vw, 840px); background:#141418;color:#e7e7ef;border-radius:12px;padding:16px 18px}
#sheetCard h2{margin:0 0 6px 0}
#invTable{width:100%;border-collapse:collapse;margin-top:8px}
#invTable th,#invTable td{border-bottom:1px solid #2b2b33;padding:6px 8px;font-size:14px}
#invSummary{margin-top:8px;opacity:.9}
#btnSheetClose{float:right}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#2b2b33;margin-left:6px}
</style><style>
@media (max-width:480px){ #introOverlay h1{font-size:22px} #sheetCard{width:96vw} #invTable th, #invTable td{font-size:12px}
}
</style><style>
@media (max-width:480px){ #worldStatusBox{font-size:11px}
}
</style><style>
@media (max-width:520px){ #worldStatusBox{font-size:11px} #rationalPanel{max-height:45vh}
}
</style><style>
#grandezasBox{box-shadow:0 6px 16px rgba(0,0,0,.25)}
@media (max-width:520px){ #grandezasBox{font-size:11px; min-width:200px}
}
</style><style>
@media (max-width:520px){ #grandezasBox{font-size:11px}
}
</style><body><script id='__LEXIS_PACKS__' type='application/json'>{"meta": {"name": "lexis_universal_packs", "generated": "2025-09-03T16:41:44.332510Z"}, "juridicas": {"GLOBAL": [{"id": "UDHR-1948", "titulo": "Declaração Universal dos Direitos Humanos", "escopo": "Direitos Humanos"}], "BR": [{"id": "CF-1988", "titulo": "Constituição Federal 1988"}, {"id": "CP-1940", "titulo": "Código Penal"}, {"id": "CPP-1941", "titulo": "Código de Processo Penal"}, {"id": "CTB-1997", "titulo": "Código de Trânsito Brasileiro"}, {"id": "LGPD-2018", "titulo": "Lei Geral de Proteção de Dados"}, {"id": "ED-2003", "titulo": "Estatuto do Desarmamento"}]}, "fisica": {"mecanica": ["Inércia", "F=ma", "Ação-Reação", "Gravidade (g≈9.81 m/s²)"], "termo": ["Conservação de energia", "2ª Lei (entropia)", "3ª Lei (T→0)"], "ondas": ["Velocidade do som em ar ~343 m/s a 20°C"]}, "quimica": {"conservacao": ["Conservação de massa", "Conservação de carga"], "reacoes": ["Cinética depende de T", "Combustão requer O₂ + combustível + ignição"]}, "biologia": {"fisiologia": ["Homeostase", "Limites humanos (fadiga, dor, sangramento)"], "patogenos": ["Infecção requer via de exposição e dose"], "genetica": ["Herdabilidade e variação"]}, "ecologia": {"ciclos": ["Água", "Carbono", "Nitrogênio"], "dinamica": ["Sucessão ecológica", "Capacidade de suporte"]}, "astronomia": {"grav": ["Lei da Gravitação Universal", "Marés (influência lunar)"], "orb": ["Dia/noite, estações, posição solar/lunar"]}}</script><header><div class="title">Corpo — v9 • Universo Vivo</div><div class="sub">ALMA • RAZÃO • GUARDIÃO • ORDEM • ÚTERO • FORÇA • LEXIS • Boot Unificado • Memórias em camadas • Imagens de contexto • Autosave</div></header><div class="container"><section id="status" class="card"><div class="row" style="justify-content:space-between;"><div><div class="pill" id="hdStatus">Cérebro: pack embutido • 2025-09-03T16:31:08.987890Z • boot unificado</div><div class="small" id="bootMsg">Inicializando universo…</div></div><div class="row"><label class="btn">Carregar HD externo <input type="file" id="fileInput" accept=".zip,.json" style="display:none;"></label><button class="btn" id="btnContinue" style="display:none;">Continuar</button></div></div></section><section class="cols"><div><section id="avatar" class="card" style="display:none;"><h3>Escolha seu avatar (mundo inteiro)</h3><div class="row"><input type="text" id="searchChar" placeholder="Buscar por nome, PID, atributo…"><button class="btn" id="btnNew">Criar personagem</button></div><div id="avatarGrid" class="grid" style="margin-top:8px;"></div></section><section id="play" class="card" style="display:none;"><div id="state" class="muted"></div><div id="narrativa" class="log" style="margin-top:8px;"></div><div class="gallery" id="sceneGallery" style="margin-top:8px;"></div><div class="hr"></div><div id="choices" class="grid"></div><div class="row" style="margin-top:8px;"><input type="text" id="inputText" placeholder="Digite comando… (ex.: 'inventário', 'conversar', 'save tigre')"/><button class="btn" id="sendBtn">Enviar</button></div><div class="small">Autosave a cada 2 escolhas • 'save NOME' cria save paralelo numerado com data • Imagens únicas por cena.</div></section></div><div><section id="panel" class="card" style="display:none;"><h3>Painel do Mundo</h3><div><span class="pill">Timeline</span></div><div id="timelineBox" class="log small"></div><div class="hr"></div><div><span class="pill">Memórias (janela)</span></div><div id="memBox" class="log small"></div><div class="hr"></div><div><span class="pill">Saves</span></div><div id="savesList"></div></section></div></section></div><script>
/* =========================================== BOOT UNIFICADO — Universo liga como um só
=========================================== */
const $ = sel => document.querySelector(sel); // ----- Persistência local (overlay) -----
const STORE_OVERLAY = "corpo_v9_overlay";
const STORE_SAVES = "corpo_v9_saves";
const STORE_ACTIVE = "corpo_v9_active";
const STORE_MEM = "corpo_v9_mem"; function getOverlay(){ try{ return JSON.parse(localStorage.getItem(STORE_OVERLAY)||"{}"); }catch(_){ return {}; } }
function setOverlay(v){ localStorage.setItem(STORE_OVERLAY, JSON.stringify(v)); }
function writeJSON(path, obj){ const o=getOverlay(); o[path]=JSON.stringify(obj); setOverlay(o); }
function writeText(path, txt){ const o=getOverlay(); o[path]=String(txt); setOverlay(o); }
function readText(path){ const o=getOverlay(); return (o[path]!==undefined? o[path] : (window.__HD_PACK[path]||null)); }
function readJSON(path){ const raw=readText(path); try{ return raw? JSON.parse(raw): null; }catch(_){ return null; } } function getSaves(){ try{ return JSON.parse(localStorage.getItem(STORE_SAVES)||"{}"); }catch(_){ return {}; } }
function setSaves(v){ localStorage.setItem(STORE_SAVES, JSON.stringify(v)); }
function setActiveKey(k){ localStorage.setItem(STORE_ACTIVE, k); }
function getActive(){ const k=localStorage.getItem(STORE_ACTIVE); if(!k) return null; const s=getSaves(); return s[k]||null; } function pushMem(line){ const arr = (JSON.parse(localStorage.getItem(STORE_MEM)||"[]")); arr.push({t:Date.now(), line}); localStorage.setItem(STORE_MEM, JSON.stringify(arr)); renderMem(); } // ----- HD mínimo embutido -----
window.__HD_PACK = window.__HD_PACK || { "timeline/marco0.json": JSON.stringify({ ts: Date.now(), descricao: "Marco 0: mundo desperta." }), "personagens/P001_Tigre/identidade.json": JSON.stringify({ pid:"P001_Tigre", nome:"Tigre", genero:"M", idade:27, altura:1.55, olhos:"vermelhos", cabelos:"negros", corpo:"forte definido", tracos:"Rugal × Guts × Iori (Orochi)", habitos:["charuto de cannabis"], familia:{esposa:"Carol", filhos:3}, origem:{distrito:"D1"}, destino:{distrito:"D4", referencia:"Rua do Tigre, após ponte/portão, 47 casas"} }), "personagens/index.json": JSON.stringify({"P001_Tigre":{nome:"Tigre", genero:"M", idade:27}}), "afinidades/index.json": JSON.stringify({"P001_Tigre":{"P002_Carol":90, "FILHOS":100}}), "veiculos/index.json": JSON.stringify({"V001_Honda_HRV_2019":{"modelo":"Honda HR-V 2019","placa":"D1-TRG-001","dono":"P001_Tigre"}}), "armas/index.json": JSON.stringify({ "A001_Thompson":{"tipo":"arma","modelo":"Thompson","capacidade":100,"quantidade_tambores":2}, "A002_Doze":{"tipo":"arma","modelo":"Doze cartucheira","cartuchos":50}, "A003_Rev38":{"tipo":"arma","modelo":".38 boca larga","municao":30} }), "linha_do_tempo/index.json": JSON.stringify({"principal":{"id":"principal","nome":"Linha Principal","saves":[],"memorias":[]},"paralelas":{}}), "imagens/index.json": JSON.stringify({})
}; // ----- Núcleo das IAs -----
const ORDEM = { leis:["realidade","coerência","integridade","contexto","nexo"], impor(){ // garantir index de identidades const idx = readJSON("personagens/index.json")||{}; Object.keys(window.__HD_PACK).forEach(k=>{ if(k.startsWith("personagens/") && k.endsWith("identidade.json")){ const pid = k.split("/")[1]; const ident = readJSON(k); if(ident && !idx[pid]) idx[pid] = { nome: ident.nome||pid, genero: ident.genero||"?" }; } }); writeJSON("personagens/index.json", idx); return true; }
}; const RAZAO = { ensure(){ ["personagens/index.json","afinidades/index.json","linha_do_tempo/index.json","imagens/index.json", "veiculos/index.json","armas/index.json","distritos/index.json","ruas/index.json","casas/index.json" ].forEach(p=>{ if(readText(p)===null) writeJSON(p,{}); }); }, indexar(identPath){ const ident = readJSON(identPath)||{}; const pid = ident.pid || identPath.split("/")[1]; const idx = readJSON("personagens/index.json")||{}; idx[pid] = { nome: ident.nome||pid, genero: ident.genero||"?", idade: ident.idade||"?" }; writeJSON("personagens/index.json", idx); }, comporPromptCena(ctx){ // prompt simples baseado no contexto atual const who = ctx.avatar?.nome || ctx.avatar?.pid || "Personagem"; const loc = ctx.location || "ambiente urbano"; const itens = (ctx.itens||[]).join(", "); const tom = "estilo mangá, alto contraste, enquadramento cinematográfico"; return `${tom}; ${who} em ${loc}; elementos: ${itens}`.trim(); }
}; const ALMA = { plch(text){ const c=document.createElement("canvas"); c.width=768; c.height=512; const g=c.getContext("2d"); g.fillStyle="#0f121c"; g.fillRect(0,0,c.width,c.height); g.fillStyle="#1c2233"; g.fillRect(16,16,c.width-32,c.height-32); g.fillStyle="#cbd5e1"; g.font="bold 22px ui-monospace"; const s=(text||"cena").slice(0,46); g.fillText(s, 28, 64); return c.toDataURL("image/png"); }, saveImg(path, dataURL){ writeText(path, dataURL); const idx = readJSON("imagens/index.json")||{}; idx[path]={t:Date.now()}; writeJSON("imagens/index.json", idx); }, getPortrait(pid){ const p1=`imagens/personagens/${pid}/portrait.png`, p2=`imagens/personagens/${pid}.png`; return readText(p1) || readText(p2) || ALMA.plch(pid); }
}; const GUARDIAO = { idx(){ return readJSON("linha_do_tempo/index.json") || {"principal":{"id":"principal","saves":[],"memorias":[]},"paralelas":{}}; }, write(v){ writeJSON("linha_do_tempo/index.json", v); }, abrirParalela(base){ const idx=this.idx(); const stamp=new Date().toISOString().replace(/[:.]/g,"-"); const id=(base||"linha")+"@"+stamp; idx.paralelas[id]={id, nome:base||"Linha", saves:[], memorias:[], marco0: (readJSON("timeline/marco0.json")||{}).ts || Date.now()}; this.write(idx); return id; }, salvarMem(linhaId, memo){ const idx=this.idx(); const bucket=(linhaId==="principal")? idx.principal : (idx.paralelas[linhaId]||null); if(!bucket) return; bucket.memorias.push(memo); this.write(idx); }, regSave(linhaId, key){ const idx=this.idx(); const bucket=(linhaId==="principal")? idx.principal : (idx.paralelas[linhaId]||null); if(!bucket) return; const num=(bucket.saves?.length||0)+1; bucket.saves.push({num, key, data:new Date().toLocaleString()}); this.write(idx); }
}; const UTERO = { varrer(){ const problemas=[]; const idx = readJSON("personagens/index.json")||{}; // Afinidades reflexivas ou self const af = readJSON("afinidades/index.json")||{}; Object.keys(af).forEach(a=>{ Object.keys(af[a]||{}).forEach(b=>{ if(a===b) problemas.push({tipo:"afinidade_reflexiva",a,b}); }); }); // Identidades sem index Object.keys(window.__HD_PACK).forEach(k=>{ if(k.startsWith("personagens/") && k.endsWith("identidade.json")){ const pid=k.split("/")[1]; if(!idx[pid]) problemas.push({tipo:"index_missing", pid}); } }); return problemas; }, corrigir(lista){ lista.forEach(p=>{ if(p.tipo==="afinidade_reflexiva"){ const af=readJSON("afinidades/index.json")||{}; if(af[p.a]) delete af[p.a][p.b]; writeJSON("afinidades/index.json", af); } if(p.tipo==="index_missing"){ const path=`personagens/${p.pid}/identidade.json`; if(readText(path)){ RAZAO.indexar(path); } } }); }, simular1000(){ for(let i=0;i<1000;i++){ ORDEM.impor(); const ps=UTERO.varrer(); if(ps.length) UTERO.corrigir(ps); } }, loop(){ setInterval(()=>{ ORDEM.impor(); const ps=UTERO.varrer(); if(ps.length) UTERO.corrigir(ps); }, 3000); }
}; // ----- Universo/Avatares -----
let AVATAR_CACHE=[];
function buildAvatarCache(){ AVATAR_CACHE=[]; Object.keys(window.__HD_PACK).forEach(k=>{ if(k.startsWith("personagens/") && k.endsWith("identidade.json")){ const ident=readJSON(k); if(ident){ const pid=k.split("/")[1]; AVATAR_CACHE.push({pid, nome:ident.nome||pid, genero:ident.genero||"?", idade:ident.idade||"?"}); } } }); // Overlay também const ov=getOverlay(); Object.keys(ov).forEach(k=>{ if(k.startsWith("personagens/") && k.endsWith("identidade.json")){ const ident=readJSON(k); if(ident){ const pid=k.split("/")[1]; if(!AVATAR_CACHE.find(x=>x.pid===pid)){ AVATAR_CACHE.push({pid, nome:ident.nome||pid, genero:ident.genero||"?", idade:ident.idade||"?"}); } } } });
} function listAvatars(q=""){ q=(q||"").toLowerCase().trim(); if(!q) return AVATAR_CACHE.slice(0,200); return AVATAR_CACHE.filter(p=> (p.pid+" "+p.nome+" "+p.genero+" "+p.idade).toLowerCase().includes(q));
} function renderAvatars(q=""){ const grid=$("#avatarGrid"); grid.innerHTML=""; const list=listAvatars(q); if(list.length===0){ const d=document.createElement("div"); d.className="muted"; d.textContent="Nada encontrado."; grid.appendChild(d); return; } list.forEach(p=>{ const d=document.createElement("div"); d.className="choice"; const img=ALMA.getPortrait(p.pid); d.innerHTML = `<div class="avatar-card"><img src="${img}" alt="portrait"><div><div><b>${p.nome}</b><span class="muted">(${p.pid})</span></div><div class="small">idade: ${p.idade} • gênero: ${p.genero}</div></div></div>`; d.onclick=()=>startGame(p); grid.appendChild(d); });
} // ----- Jogo -----
let game = { turn:0, choiceCount:0, avatar:null, linha:"principal", narrativa:"", location:"D1", destiny:"D4", marco0: (readJSON("timeline/marco0.json")||{}).ts || Date.now() }; function ensureKey(){ if(!game._key){ const base=(game.avatar?.nome||"sessao"); const now=new Date().toISOString().replace(/[:.]/g,"-"); game._key=base+"@"+now; setActiveKey(game._key); persist(); } else setActiveKey(game._key); }
function persist(){ const saves=getSaves(); if(game._key) saves[game._key]=JSON.parse(JSON.stringify(game)); setSaves(saves); } function setState(s){ game.uiState=s; $("#state").textContent=s; persist(); } function appendNarr(t){ const el=$("#narrativa"); if(game.narrativa && !el.textContent) el.textContent=game.narrativa; el.textContent += (el.textContent?"\n":"")+t; game.narrativa=el.textContent; persist(); renderSceneImage(); } function bumpAutoSave(){ game.choiceCount++; if(game.choiceCount%2===0){ ensureKey(); persist(); GUARDIAO.regSave(game.linha, game._key); pushMem("Δ autosave"); renderTimeline(); } } function dayIndex(){ const d = Math.floor( (Date.now() - (game.marco0||Date.now())) / (24*3600*1000) ); return Math.max(0,d); } function saveMemoryLayer(texto, ctx){ const linha=game.linha; const dia = dayIndex(); const ts = Date.now(); const cenaId = `${ts}`; // imagem const imgPath = `imagens/cenas/${linha}/${dia}/${cenaId}.png`; const prompt = RAZAO.comporPromptCena(ctx||game); const dataURL = ALMA.plch(prompt); ALMA.saveImg(imgPath, dataURL); // memória const memo = { t: ts, linha, dia, cenaId, texto, ctx: { avatar: game.avatar, location: game.location, destiny: game.destiny }, img: imgPath, prompt }; writeJSON(`memorias/${linha}/${dia}/${cenaId}.json`, memo); GUARDIAO.salvarMem(linha, {t:ts, dia, cenaId, ref:`memorias/${linha}/${dia}/${cenaId}.json`}); renderTimeline(); renderMem(); return memo;
} function renderSceneImage(){ const box=$("#sceneGallery"); box.innerHTML=""; const linha=game.linha; const dia=dayIndex(); // pega última memória da linha const idx = GUARDIAO.idx(); const bucket = (linha==="principal")? idx.principal : (idx.paralelas[linha]||{}); const mems = bucket.memorias||[]; const last = mems[mems.length-1]; if(last){ const memo = readJSON(last.ref); const img = readText(memo?.img); if(img){ const el=document.createElement("img"); el.src=img; box.appendChild(el); } }else{ // se não houver memória ainda, cria uma de abertura const m = saveMemoryLayer("Abertura de cena.", game); const el=document.createElement("img"); el.src=readText(m.img); box.appendChild(el); }
} function showChoices(list){ const grid=$("#choices"); grid.innerHTML=""; list.forEach(ch=>{ const d=document.createElement("div"); d.className="choice"; d.textContent=ch.label; d.onclick=()=>doChoice(ch.id); grid.appendChild(d); }); game._choices=list; persist();
} function startGame(p){ const linha = GUARDIAO.abrirParalela(p.nome||p.pid); game = { turn:0, choiceCount:0, avatar:p, linha, narrativa:"", location:"D1", destiny:"D4", marco0:(readJSON("timeline/marco0.json")||{}).ts||Date.now() }; ensureKey(); $("#avatar").style.display="none"; $("#play").style.display=""; $("#panel").style.display=""; setState(`Marco 0 • Avatar: ${p.nome} • Linha: ${linha}`); appendNarr(`${p.nome} entra no instante do Marco 0. O mundo já está em movimento.`); saveMemoryLayer("Entrada do avatar no Marco 0.", game); const ch=[ {id:"seguir", label:"Seguir"}, {id:"inventario", label:"Inventário"}, {id:"conversar", label:"Conversar"}, {id:"saves", label:"Saves"}, {id:"timeline", label:"Timeline"} ]; showChoices(ch);
} function doChoice(id){ if(id==="seguir"){ const t="O relógio avança. Você segue a rota/rotina respeitando o Marco 0."; appendNarr(t); saveMemoryLayer(t, game); } else if(id==="inventario"){ const t="Inventário consultado (ver ficha no HD)."; appendNarr(t); saveMemoryLayer(t, game); } else if(id==="conversar"){ const alvo="Carol"; const t=`Você inicia conversa com ${alvo}.`; appendNarr(t); saveMemoryLayer(t, game); } else if(id==="saves"){ openSaves(); bumpAutoSave(); return; } else if(id==="timeline"){ renderTimeline(); bumpAutoSave(); return; } bumpAutoSave();
} function handleText(txt){ const lower=txt.toLowerCase().trim(); pushMem("CMD · "+txt); if(lower.startsWith("save")){ const name = txt.slice(4).trim() || (game.avatar?.nome || "save"); const key = name+"@"+new Date().toISOString().replace(/[:.]/g,"-"); const saves=getSaves(); saves[key]=JSON.parse(JSON.stringify(game)); setSaves(saves); setActiveKey(key); GUARDIAO.regSave(game.linha, key); appendNarr("⎯ Save '"+name+"' criado."); renderSaves(); return; } if(lower.includes("invent")) return doChoice("inventario"); if(lower.includes("convers")) return doChoice("conversar"); const t="Ação integrada ao contexto. Memória de camada criada."; appendNarr(t); saveMemoryLayer(t, game); bumpAutoSave();
} // ----- UI Aux -----
function renderTimeline(){ const box=$("#timelineBox"); const idx=GUARDIAO.idx(); const lines=[]; lines.push("— Principal —"); const p=idx.principal||{}; (p.saves||[]).forEach(s=>lines.push(`save #${s.num} • ${s.data} • ${s.key}`)); lines.push(""); lines.push("— Paralelas —"); Object.values(idx.paralelas||{}).forEach(L=>{ lines.push(`· ${L.id} (saves:${L.saves?.length||0} mem:${L.memorias?.length||0})`); }); box.textContent=lines.join("\n")||"Sem eventos.";
} function renderMem(){ const arr = (JSON.parse(localStorage.getItem(STORE_MEM)||"[]")); const last = arr.slice(-250).map(x=>`[${new Date(x.t).toLocaleTimeString()}] ${x.line}`).join("\n"); $("#memBox").textContent = last || "Vazio.";
} function renderSaves(){ const box=$("#savesList"); box.innerHTML=""; const saves=getSaves(); const keys=Object.keys(saves).sort().reverse(); if(keys.length===0){ box.innerHTML='<div class="muted">Nenhum save.</div>'; return; } keys.forEach(k=>{ const row=document.createElement("div"); row.className="row"; const btnL=document.createElement("button"); btnL.className="btn"; btnL.textContent="Carregar"; btnL.onclick=()=>loadSave(k); const btnA=document.createElement("button"); btnA.className="btn"; btnA.textContent="Ativar"; btnA.onclick=()=>setActiveKey(k); const btnD=document.createElement("button"); btnD.className="btn"; btnD.textContent="Excluir"; btnD.onclick=()=>{ const s=getSaves(); delete s[k]; setSaves(s); renderSaves(); }; const meta=document.createElement("div"); meta.className="pill"; meta.textContent=k; row.appendChild(btnL); row.appendChild(btnA); row.appendChild(btnD); row.appendChild(meta); box.appendChild(row); });
} function loadSave(k){ const s=getSaves()[k]; if(!s) return; game=s; setActiveKey(k); $("#avatar").style.display="none"; $("#play").style.display=""; $("#panel").style.display=""; $("#narrativa").textContent=game.narrativa||""; setState(game.uiState||"Save carregado"); showChoices(game._choices||[]); renderTimeline(); renderMem(); renderSaves(); renderSceneImage();
} // ----- Entrada -----
$("#sendBtn").onclick=()=>{ const inp=$("#inputText"); const v=inp.value.trim(); if(!v) return; handleText(v); inp.value=""; };
$("#inputText").addEventListener("keydown", e=>{ if(e.key==="Enter") $("#sendBtn").click(); });
$("#searchChar").addEventListener("input", e=>renderAvatars(e.target.value));
$("#btnNew").onclick=()=>{ // Criação simples substituindo NPC de baixa conexão (simulado) const name=prompt("Nome do novo personagem:"); if(!name) return; const pid="P"+Math.random().toString(36).slice(2,8).toUpperCase()+"_"+name.replace(/\s+/g,""); writeJSON(`personagens/${pid}/identidade.json`, {pid, nome:name, genero:"X", idade:"?", origem:{}, destino:{}}); RAZAO.indexar(`personagens/${pid}/identidade.json`); buildAvatarCache(); renderAvatars("");
}; // ----- Leitor de pack externo (json ou ZIP STORE sem compressão) -----
const fileInput = document.querySelector("#fileInput");
fileInput.addEventListener("change", async (e)=>{ const f=e.target.files[0]; if(!f) return; const name=f.name.toLowerCase(); const bootMsg=$("#bootMsg"); try{ if(name.endsWith(".json")){ const txt=await f.text(); const obj=JSON.parse(txt); window.__HD_PACK=obj; $("#hdStatus").textContent="Cérebro: pack externo (JSON)"; bootMsg.textContent="Pack JSON carregado."; ORDEM.impor(); buildAvatarCache(); renderAvatars(""); UTERO.simular1000(); } else if(name.endsWith(".zip")){ const files = await readZipStoreOnly(f); if(files["data_pack.json"]){ const obj=JSON.parse(files["data_pack.json"]); window.__HD_PACK=obj; $("#hdStatus").textContent="Cérebro: ZIP STORE"; bootMsg.textContent="ZIP STORE carregado."; ORDEM.impor(); buildAvatarCache(); renderAvatars(""); UTERO.simular1000(); } else bootMsg.textContent="ZIP sem data_pack.json"; } }catch(err){ bootMsg.textContent="Falha: "+err.message; }
}); async function readZipStoreOnly(file){ const ab=await file.arrayBuffer(); const dv=new DataView(ab); const dec=new TextDecoder("utf-8"); let pos=0; const files={}; function u16(o){ return dv.getUint16(o,true);} function u32(o){ return dv.getUint32(o,true);} while(pos+30<=ab.byteLength){ const sig=u32(pos); if(sig!==0x04034b50){ pos++; continue; } const method=u16(pos+8); const comp=u32(pos+18); const nameLen=u16(pos+26); const extraLen=u16(pos+28); const nameBytes=new Uint8Array(ab,pos+30,nameLen); const name=dec.decode(nameBytes); const dataStart=pos+30+nameLen+extraLen; const dataEnd=dataStart+comp; if(method!==0) throw new Error("ZIP com compressão não suportado nesta versão."); const dataBytes=new Uint8Array(ab,dataStart,comp); const content=dec.decode(dataBytes); files[name]=content; pos=dataEnd; } return files;
} /* =========================================== IA FORÇA — Coesão global em 1s loop Varre TUDO (HD embutido + overlay) e mantém união, contexto, coerência e continuidade temporal.
=========================================== */
const FORCA = { lastHash: "", stats: { scans:0, inconsistencias:0, reparos:0, ult:0 }, digest(){ // cria um hash simples da visão do universo (chaves + tamanhos) const keys = Object.keys(window.__HD_PACK).sort(); const ov = getOverlay(); const okeys = Object.keys(ov).sort(); let acc = keys.join("|")+"||"+okeys.join("|"); // inclui contadores de memórias e saves para detectar mudança de estado const idx = GUARDIAO.idx(); const pCount = (idx.principal?.memorias?.length||0)+(idx.principal?.saves?.length||0); let para = 0; Object.values(idx.paralelas||{}).forEach(L=>{ para += (L.memorias?.length||0)+(L.saves?.length||0); }); acc += "||M"+pCount+"|P"+para; return acc; }, varrer(){ this.stats.scans++; this.stats.ult = Date.now(); // 1) aplicar ORDEM e RAZAO mínimas a cada batida ORDEM.impor(); RAZAO.ensure(); // 2) checar index de personagens para todo identidade.json const idx = readJSON("personagens/index.json")||{}; Object.keys(window.__HD_PACK).forEach(k=>{ if(k.startsWith("personagens/") && k.endsWith("identidade.json")){ const pid=k.split("/")[1]; if(!idx[pid]){ this.stats.inconsistencias++; RAZAO.indexar(k); this.stats.reparos++; } } }); const ov = getOverlay(); Object.keys(ov).forEach(k=>{ if(k.startsWith("personagens/") && k.endsWith("identidade.json")){ const pid=k.split("/")[1]; if(!idx[pid]){ this.stats.inconsistencias++; RAZAO.indexar(k); this.stats.reparos++; } } }); // 3) timeline sempre válida const tl = GUARDIAO.idx(); if(!tl.principal){ tl.principal={id:"principal", nome:"Linha Principal", saves:[], memorias:[]}; GUARDIAO.write(tl); this.stats.reparos++; } // 4) afinidades sem self e simetria opcional leve (não cria laço novo, apenas remove inválido) const af = readJSON("afinidades/index.json")||{}; let touched=false; Object.keys(af).forEach(a=>{ Object.keys(af[a]||{}).forEach(b=>{ if(a===b){ delete af[a][b]; this.stats.inconsistencias++; touched=true; this.stats.reparos++; } }); }); if(touched) writeJSON("afinidades/index.json", af); // 5) se hash do universo mudou, atualizar indicadores const h=this.digest(); if(h!==this.lastHash){ this.lastHash=h; // atualizar painel visual com batimento const boot = $("#bootMsg"); if(boot){ boot.textContent = "Universo coeso • último scan: "+new Date(this.stats.ult).toLocaleTimeString(); } } }, loop(){ setInterval(()=>this.varrer(), 1000); }
}; /* ============================= LEXIS Universal (leis naturais + jurídicas) Consulta pacotes embutidos em __LEXIS_PACKS__ e aplica sobre eventos conforme o contexto.
============================= */
const LEXIS = (function(){ const PACK = JSON.parse(document.getElementById('__LEXIS_PACKS__').textContent); const S = {stats:{checks:0, aplicacoes:0, correcoes:0, ult:0}}; function classificar(evt){ // Heurística simples: tipificar pelo payload if(evt.tipo) return evt.tipo; if(evt.bala || evt.tiro || evt.arma) return "fisica/balistica"; if(evt.fogo || evt.explosao) return "quimica/combustao"; if(evt.saude || evt.sangue || evt.veneno) return "biologia/fisiologia"; if(evt.policia || evt.crime || evt.trânsito) return "juridicas/penal"; if(evt.mar || evt.lua || evt.mare) return "astronomia/mare"; return "contexto/geral"; } function aplicar(evt, distrito){ S.stats.checks++; S.stats.ult = Date.now(); const tipo = classificar(evt); let ok = true; let notas=[]; let correcoes=0; // FÍSICA — gravidade & afins if(tipo.startsWith("fisica")){ // trajetória básica de projétil (parábola) e perda de energia if(evt.tiro){ if(evt.alcance==null) evt.alcance = 50; // m default if(evt.perdaEnergia==null) evt.perdaEnergia = true; notas.push("Balística: trajetória parabólica; energia decai com distância."); } if(evt.objetoArremessado){ evt.volta = true; // cai por gravidade notas.push("Gravidade ativa: objeto retorna ao solo."); } } // QUÍMICA — combustão & toxicidade if(tipo.startsWith("quimica")){ if(evt.fogo){ evt.requer = evt.requer || ["O2","combustível","ignição"]; notas.push("Combustão exige O2 + combustível + ignição."); } if(evt.veneno && !evt.viaExposicao){ evt.viaExposicao = "ingestão/inalação/contato"; correcoes++; notas.push("Toxicidade requer via de exposição definida."); } } // BIOLOGIA — ferimentos & doença if(tipo.startsWith("biologia")){ if(evt.sangue && !evt.hemostasia){ evt.hemostasia = "compressão/torniquete"; correcoes++; notas.push("Sangramento exige resposta fisiológica/intervenção."); } if(evt.infeccao && !evt.dose){ evt.dose = "desconhecida"; notas.push("Risco depende de dose e via de exposição."); } } // ASTRONOMIA — marés, visibilidade if(tipo.startsWith("astronomia")){ if(evt.mare && evt.luaFase==null){ evt.luaFase = "aprox"; correcoes++; notas.push("Amplitude de maré depende da fase lunar."); } } // JURÍDICAS — por distrito if(tipo.startsWith("juridicas")){ // Exemplo mínimo: porte de arma & trânsito const D = (readJSON("mundo/leis/juridicas/index.json")||{})[distro] || {}; if(evt.crime==="porte_arma"){ const permitido = D.permite_porte || false; if(!permitido){ evt.consequencia = "prisao/multa"; notas.push("Porte ilegal no distrito."); } } if(evt.trânsito && evt.vel > (D.velocidade_max || 60)){ evt.infracao = "excesso_velocidade"; notas.push("CTB/lei local: excesso de velocidade."); } } if(correcoes>0){ S.stats.correcoes+=correcoes; } if(notas.length){ evt._lexis = notas; S.stats.aplicacoes++; } return {evt, ok, notas}; } function idx(){ return PACK; } return {aplicar, idx, stats:()=>S.stats};
})(); // Conectar LEXIS ao ciclo do motor
(function wireLexis(){ // RAZAO e ORDEM devem existir if(typeof RAZAO!=="undefined"){ const _compose = RAZAO.composeCena; RAZAO.composeCena = function(contexto){ // 1) aplica LEXIS em cada evento bruto antes de compor resposta const evts = contexto.eventos || []; const distrito = (contexto.distrito || "D1"); for(let i=0;i<evts.length;i++){ LEXIS.aplicar(evts[i], distrito); } // 2) segue fluxo normal return _compose.call(RAZAO, contexto); } } // FORCA chama LEXIS indiretamente via ORDEM/RAZAO a cada batida if(typeof FORCA!=="undefined"){ const _scan = FORCA.varrer.bind(FORCA); FORCA.varrer = function(){ const r=_scan(); LEXIS.stats().checks; return r; } }
})(); /* Estrutura mínima de leis no HD embutido */
(function ensureLawFS(){ const baseIdx = readJSON("mundo/leis/fundamentos.json") || {}; if(!baseIdx.juridicas){ baseIdx.juridicas = ["GLOBAL","BR"]; } if(!baseIdx.fisica){ baseIdx.fisica = ["mecanica","termo","ondas"]; } if(!baseIdx.quimica){ baseIdx.quimica = ["conservacao","reacoes"]; } if(!baseIdx.biologia){ baseIdx.biologia = ["fisiologia","patogenos","genetica"]; } if(!baseIdx.ecologia){ baseIdx.ecologia = ["ciclos","dinamica"]; } if(!baseIdx.astronomia){ baseIdx.astronomia = ["grav","orb"]; } writeJSON("mundo/leis/fundamentos.json", baseIdx); const jurIdx = readJSON("mundo/leis/juridicas/index.json") || {}; // Defaults por distrito (podem ser editados via HD externo) ["D1","D2","D3","D4","D5","D6","D7"].forEach(D=>{ if(!jurIdx[D]) jurIdx[D] = { permite_porte:false, velocidade_max:60 }; }); writeJSON("mundo/leis/juridicas/index.json", jurIdx);
})(); // ====== FICHA & INVENTÁRIO ======
const UI = (function(){ function kg(x){ return Math.round(x*100)/100; } function pesoTotal(inv){ return Object.values(inv||{}).reduce((acc,it)=>acc + (it.peso||0)*(it.qtd||1), 0); } function capacidade(p){ // capacidade por constituição simples const base = 20; // kg base const mod = (p.constituicao||0)/10 * 5; // +5kg por 10 pontos return base + mod; } function abrirFicha(p){ const modal = document.getElementById("sheetModal"); document.getElementById("sheetNome").textContent = p.nome||"—"; document.getElementById("sheetId").textContent = p.id||"—"; document.getElementById("sheetAparencia").innerHTML = `<b>Aparência:</b> ${p.aparencia||"—"} <span class="badge">Beleza: ${p.beleza||"—"}</span><span class="badge">Sex Appeal: ${p.sex_appeal||"—"}</span>`; document.getElementById("sheetAfinidade").innerHTML = `<b>Afinidades:</b> ${Object.keys(p.afinidades||{}).length} vínculos`; const tbody = document.querySelector("#invTable tbody"); tbody.innerHTML=""; const inv = p.inventario||{}; Object.keys(inv).forEach(k=>{ const it = inv[k]; const tr = document.createElement("tr"); tr.innerHTML = `<td>${k}</td><td>${it.qtd||1}</td><td>${kg(it.peso||0)}</td><td>${kg((it.peso||0)*(it.qtd||1))}</td>`; tbody.appendChild(tr); }); const total = kg(pesoTotal(inv)); const cap = kg(capacidade(p)); const ok = total <= cap; document.getElementById("invSummary").innerHTML = `Peso total: <b>${total} kg</b> / Capacidade: <b>${cap} kg</b> ${ok?"":"<span class='badge'>Excesso</span>"}`; modal.style.display = "block"; } function fecharFicha(){ document.getElementById("sheetModal").style.display="none"; } return {abrirFicha, fecharFicha};
})();
document.getElementById("btnSheetClose").onclick = UI.fecharFicha; /* ===== Distritos / Ruas / Casas + Leis personalizadas ===== */
(function ensureWorldGeography(){ const D = readJSON("distritos/index.json") || {}; if(!D.D1) D.D1 = {nome:"Distrito 1", tipo:"urbano", pais:"EUA", leis:{permite_porte:false, velocidade_max:50}}; if(!D.D2) D.D2 = {nome:"Distrito 2", tipo:"urbano", pais:"Brasil", leis:{permite_porte:false, velocidade_max:60}}; if(!D.D3) D.D3 = {nome:"Distrito 3", tipo:"industrial", pais:"Leste", leis:{permite_porte:false, velocidade_max:70}}; if(!D.D4) D.D4 = {nome:"Distrito 4", tipo:"semi-rural", pais:"Mediterrâneo", leis:{permite_porte:true, velocidade_max:70}}; if(!D.D5) D.D5 = {nome:"Distrito 5", tipo:"costa", pais:"Atlântico", leis:{permite_porte:false, velocidade_max:60}}; if(!D.D6) D.D6 = {nome:"Distrito 6", tipo:"rural", pais:"Interior", leis:{permite_porte:true, velocidade_max:80}}; if(!D.D7) D.D7 = {nome:"Distrito 7", tipo:"montanha", pais:"Andes", leis:{permite_porte:false, velocidade_max:50}}; writeJSON("distritos/index.json", D); const R = readJSON("ruas/index.json") || {}; if(!R.D4) R.D4 = {}; R.D4["Rua do Tigre"] = R.D4["Rua do Tigre"] || {codigo:"RUA_TIGRE", casas:["47_pos_ponte"]}; writeJSON("ruas/index.json", R); const C = readJSON("casas/index.json") || {}; C["47_pos_ponte"] = C["47_pos_ponte"] || {distrito:"D4", rua:"Rua do Tigre", arquitetura:"alvenaria 2 pav.", cultivo:true}; writeJSON("casas/index.json", C);
})(); /* ===== IA CLIMA/ECO ===== */
const CLIMA = (function(){ const S = {tick:0, clima:{temp:24, chuva:false, vento:5, lua:"cheia"}}; function step(){ S.tick++; // ciclo simples S.clima.temp += (Math.random()-.5)*0.8; if(Math.random()<0.05) S.clima.chuva = !S.clima.chuva; S.clima.vento = Math.max(0, S.clima.vento + (Math.random()-.5)*1.5); // marés aproximadas const fases = ["nova","crescente","cheia","minguante"]; S.clima.lua = fases[(Math.floor(S.tick/300))%4]; } function aplicarAoContexto(ctx){ ctx.clima = Object.assign({}, S.clima); // efeitos simples if(S.clima.chuva) ctx.efeitos = (ctx.efeitos||[]).concat(["piso_molhado","visibilidade_reduzida"]); if(S.clima.vento>12) ctx.efeitos = (ctx.efeitos||[]).concat(["tiro_desvio_leve"]); } function loop(){ setInterval(step, 1000); } return {loop, aplicarAoContexto, state:()=>S};
})(); (function wireClima(){ if(typeof RAZAO!=="undefined"){ const _compose = RAZAO.composeCena; RAZAO.composeCena = function(ctx){ CLIMA.aplicarAoContexto(ctx); return _compose.call(RAZAO, ctx); } } CLIMA.loop();
})(); /* ===== Escolha de Linha na Intro ===== */
(function introChooser(){ function render(){ const div = document.getElementById("tlChooser"); if(!div) return; const idx = GUARDIAO.idx(); const opts = []; opts.push(`<label><input type="radio" name="linha" value="principal" checked> Linha Principal</label>`); Object.keys(idx.paralelas||{}).forEach(k=>{ opts.push(`<label><input type="radio" name="linha" value="${k}"> ${k} (${(idx.paralelas[k].saves||[]).length} saves)</label>`); }); div.innerHTML = `<b>Linhas disponíveis:</b><br>${opts.join("<br>")}`; } document.getElementById("btnIniciar").onclick = ()=>{ const sel = (document.querySelector('input[name="linha"]:checked')||{}).value || "principal"; GUARDIAO.setLinhaAtiva(sel); document.getElementById("introOverlay").style.display="none"; }; // inicializa setTimeout(render, 50);
})(); /* ===== Exportar/Importar Saves ===== */
(function saveIO(){ const root = document.body; const bar = document.createElement("div"); bar.style.position="fixed"; bar.style.bottom="10px"; bar.style.right="10px"; bar.style.background="#1c1c22"; bar.style.color="#eaeaf2"; bar.style.padding="6px 8px"; bar.style.borderRadius="8px"; bar.style.fontSize="12px"; bar.style.opacity=".85"; bar.style.zIndex="99997"; bar.innerHTML = `<button id="btnExport">Exportar Save</button><button id="btnImport">Importar Save</button><button id="btnFicha">Ficha</button>`; root.appendChild(bar); document.getElementById("btnExport").onclick = ()=>{ const data = GUARDIAO.dumpAll(); const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "corpo_saves.json"; a.click(); }; document.getElementById("btnImport").onclick = ()=>{ const inp = document.createElement("input"); inp.type="file"; inp.accept="application/json"; inp.onchange = ()=>{ const f = inp.files[0]; const fr = new FileReader(); fr.onload = ()=>{ try{ const obj = JSON.parse(fr.result); GUARDIAO.loadAll(obj); alert("Saves importados."); }catch(e){ alert("Arquivo inválido."); } }; fr.readAsText(f); }; inp.click(); }; // abrir ficha do personagem ativo document.getElementById("btnFicha").onclick = ()=>{ const p = window.__PERSONAGEM_ATIVO__||{}; UI.abrirFicha(p); };
})(); /* ===== Patch inventário Tigre com pesos ===== */
(function patchTigre(){ const path = "personagens/P001_Tigre/identidade.json"; const id = readJSON(path) || {}; if(!id.inventario){ id.inventario = { ".38 boca larga": {qtd:1, peso:1.0}, "munição .38": {qtd:30, peso:0.012}, "HR-V (chaves)": {qtd:1, peso:0.05}, "malas": {qtd:2, peso:4.0}, "Thompson 100": {qtd:1, peso:4.9}, "cartuchos 12": {qtd:50, peso:0.033} }; } if(!id.constituicao) id.constituicao = 60; if(!id.aparencia) id.aparencia = "moreno, 1,55m, forte definido, olhos e cabelos negros; olhos rubros em foco; fuma charuto de cannabis"; if(!id.beleza) id.beleza = 7; if(!id.sex_appeal) id.sex_appeal = 8; writeJSON(path, id); window.__PERSONAGEM_ATIVO__ = Object.assign({id:"P001_Tigre", nome:"Tigre"}, id);
})(); /* ===== Validador — loop até inconsistência 0 ===== */
const VALIDADOR = (function(){ const S = {passos:0, inconsistencias:0, reparos:0, fim:false}; function passo(){ S.passos++; let inc=0, rep=0; // verificação: todos personagens com id no index const idx = readJSON("personagens/index.json")||{}; Object.keys(window.__HD_PACK).forEach(k=>{ if(k.startsWith("personagens/") && k.endsWith("identidade.json")){ const pid=k.split("/")[1]; if(!idx[pid]){ inc++; RAZAO.indexar(k); rep++; } } }); // afinidades self const af = readJSON("afinidades/index.json")||{}; Object.keys(af).forEach(a=>{ if(af[a]&&af[a][a]){ delete af[a][a]; inc++; rep++; } }); if(rep>0) writeJSON("afinidades/index.json", af); S.inconsistencias = inc; S.reparos += rep; if(inc===0){ S.fim=true; } } function loop(){ const i = setInterval(()=>{ if(S.fim) { clearInterval(i); return; } passo(); }, 150); } return {loop, state:()=>S};
})();
(function(){ VALIDADOR.loop(); })(); /* ========== MATHPREC & PHYS ==========
Precisão determinística para o Mundo Racional.
Inclui:
- MathPrec: utilitários determinísticos com seed.
- Phys: balística com arrasto (modelo quadrático), queda, colisão simples, veículos básicos.
- Armas: perfis balísticos consultados em armas/index.json (override via HD).
====================================== */
const MATHPREC = (function(){ let SEED = 1337; function srand(s){ SEED = (s|0) || 1337; } function rand(){ // xorshift32 let x = SEED|0; x^=x<<13; x^=x>>17; x^=x<<5; SEED = x; return ((x>>>0)%1e6)/1e6; } function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); } function lerp(a,b,t){ return a+(b-a)*t; } function round(x,p=3){ const k = Math.pow(10,p); return Math.round(x*k)/k; } function deg2rad(d){ return d*Math.PI/180; } function rad2deg(r){ return r*180/Math.PI; } return {srand, rand, clamp, lerp, round, deg2rad, rad2deg};
})(); const PHYS = (function(){ // Constantes físicas simplificadas const g = 9.80665; // gravidade m/s² const rho = 1.225; // densidade do ar kg/m³ (nível do mar, 15°C) // Perfis balísticos padrão const defaultGuns = { ".38_Special": {calibre_mm:9.07, massa_g:10.2, v0:260, CdA:0.0005, energiaMuzzle: null}, // valores aproximados "12_Gauge": {calibre_mm:18.53, massa_g:32.0, v0:380, CdA:0.0020, energiaMuzzle: null}, ".45_ACP": {calibre_mm:11.43, massa_g:15.0, v0:285, CdA:0.0008, energiaMuzzle: null} }; function armaIndex(){ let idx = readJSON("armas/index.json"); if(!idx){ idx = defaultGuns; writeJSON("armas/index.json", idx); } return idx; } function muzzleEnergy(m_g, v0){ // E = 1/2 m v^2 const m = m_g/1000; return 0.5*m*v0*v0; } // Integração com arrasto quadrático: Fd = 1/2 * rho * CdA * v^2 function simulateBullet({arma=".38_Special", angGraus=0, v0=null, massa_g=null, CdA=null, dt=0.002, maxT=3.0, vento=0}){ const A = armaIndex()[arma] || defaultGuns[".38_Special"]; const m_g = (massa_g!=null?massa_g:A.massa_g); const CdA_ = (CdA!=null?CdA:A.CdA); const v0_ = (v0!=null?v0:A.v0); const m = m_g/1000; const theta = MATHPREC.deg2rad(angGraus); let vx = v0_*Math.cos(theta) + vento; // vento simples como offset let vy = v0_*Math.sin(theta); let x=0, y=1.4; // altura do disparo padrão (peito) let t=0; const pts = []; while(t<maxT && y>=0){ const v = Math.sqrt(vx*vx+vy*vy); const Fd = 0.5*rho*CdA_*v*v; const ax = -(Fd/m)*(vx/(v||1)); const ay = -(Fd/m)*(vy/(v||1)) - g; // Euler vx += ax*dt; vy += ay*dt; x += vx*dt; y += vy*dt; t += dt; if((pts.length%10)===0) pts.push({t:MATHPREC.round(t,3), x:MATHPREC.round(x,3), y:MATHPREC.round(y,3), v:MATHPREC.round(v,2)}); } const E0 = muzzleEnergy(m_g, v0_); const vEnd = Math.sqrt(vx*vx+vy*vy); const Eend = 0.5*m*vEnd*vEnd; const alcance = x; return {traj:pts, alcance:MATHPREC.round(alcance,2), E0:MATHPREC.round(E0,1), Eend:MATHPREC.round(Eend,1), v0:v0_, m_g, CdA:CdA_, hitGround:(y<=0)}; } // Penetração simples (proxy): depende de energia residual e seção function penetration(energia_J, calibre_mm, material="tecido"){ const sec = Math.PI*Math.pow((calibre_mm/1000)/2,2); // m² const press = energia_J/sec; // J/m² proxy let k=1.0; if(material==="tecido") k=1.0; else if(material==="madeira") k=2.4; else if(material==="concreto") k=18.0; else if(material==="aço") k=25.0; const nivel = energia_J/(k*50); // escala arbitrária calibrada return MATHPREC.round(nivel,2); } // Ricochete (aprox): prob aumenta com ângulo raso function ricochetProb(anguloIncidenciaGraus, material="aço"){ const a = MATHPREC.clamp(anguloIncidenciaGraus,0,90); const base = (90-a)/90; // raso → alto let m=1.0; if(material==="aço") m=1.2; if(material==="concreto") m=0.9; if(material==="terra") m=0.6; return MATHPREC.round(MATHPREC.clamp(base*m,0,0.98),2); } // Queda livre com resistência linear simples (baixas velocidades) function queda(objetoMassaKg=1.0, altura=2.0, CdA=0.02, dt=0.01){ let y=altura, vy=0, t=0; const out=[]; while(y>0){ const Fd = 0.5*rho*CdA*vy*vy*Math.sign(vy); const ay = -g - (Fd/objetoMassaKg); vy += ay*dt; y += vy*dt; t+=dt; if(out.length%10===0) out.push({t:MATHPREC.round(t,2), y:MATHPREC.round(y,3), vy:MATHPREC.round(vy,2)}); } return out; } // Veículos básicos (aceleração limitada + atrito/arrasto) function veiculoStep(state, throttle=0, brake=0, dt=0.05){ const {massa=1500, v=0, area=2.2, Cd=0.32, mu=0.015, Pmax=90000} = state; const Fdrag = 0.5*rho*Cd*area*v*v; const Froll = mu*massa*g; const Ftrac = throttle * (Pmax/Math.max(v,1)) ; // força trativa aprox const Fbrake= brake * (0.6*massa*g); const a = (Ftrac - Fdrag - Froll - Fbrake)/massa; const v2 = Math.max(0, v + a*dt); return {...state, v:v2, a, Fdrag, Froll}; } return {simulateBullet, penetration, ricochetProb, queda, veiculoStep, g, rho};
})(); /* ===== Wire: aplicar PHYS automaticamente em eventos relevantes ===== */
(function wirePhysIntoNarration(){ if(typeof RAZAO==="undefined") return; const _compose = RAZAO.composeCena; RAZAO.composeCena = function(ctx){ // Clima já injetado; agora cálculos físicos (ctx.eventos||[]).forEach(evt=>{ // Disparo if(evt.tiro){ const arma = evt.arma || ".38_Special"; const ang = evt.anguloGraus!=null?evt.anguloGraus:0; const vento= (ctx.clima&&ctx.clima.vento)||0; const sim = PHYS.simulateBullet({arma:arma, angGraus:ang, vento:vento}); evt._calc = evt._calc || {}; evt._calc.balistica = sim; // Penetração aproximada no alvo/material const perfil = readJSON("armas/index.json")[arma] || {}; const calmm = perfil.calibre_mm || 9.07; const pen = PHYS.penetration(sim.Eend, calmm, evt.materialAlvo||"tecido"); evt._calc.penet = pen; // Ricochete (se ângulo definido) if(evt.anguloIncidencia!=null){ evt._calc.ricocheteProb = PHYS.ricochetProb(evt.anguloIncidencia, evt.materialAlvo||"aço"); } } // Arremesso/queda if(evt.objetoArremessado){ evt._calc = evt._calc || {}; evt._calc.queda = PHYS.queda(evt.massa||0.2, evt.altura||1.7, evt.CdA||0.01); } // Veículo if(evt.veiculo){ const s = evt.state || {massa:1500, v:evt.v||0}; const step = PHYS.veiculoStep(s, evt.throttle||0, evt.brake||0, 0.05); evt._calc = evt._calc || {}; evt._calc.veiculo = step; evt.v = step.v; } }); return _compose.call(RAZAO, ctx); }
})(); /* ===== UI Modo Racional ===== */
(function rationalUI(){ const box = document.createElement("div"); box.style.position="fixed"; box.style.top="10px"; box.style.right="10px"; box.style.background="#101016"; box.style.color="#eaeaf2"; box.style.padding="6px 8px"; box.style.borderRadius="8px"; box.style.fontSize="12px"; box.style.opacity=".9"; box.style.zIndex="99996"; box.innerHTML = `<label><input type="checkbox" id="chkRacional"> Modo Racional</label>`; document.body.appendChild(box); const panel = document.createElement("pre"); panel.id="rationalPanel"; panel.style.position="fixed"; panel.style.top="40px"; panel.style.right="10px"; panel.style.width="min(90vw,480px)"; panel.style.maxHeight="60vh"; panel.style.overflow="auto"; panel.style.background="#0c0c12"; panel.style.color="#cde3ff"; panel.style.padding="8px 10px"; panel.style.borderRadius="8px"; panel.style.display="none"; panel.style.whiteSpace="pre-wrap"; panel.style.zIndex="99995"; document.body.appendChild(panel); function showCalc(ctx){ const evts = ctx.eventos||[]; const out = []; evts.forEach((e,i)=>{ if(e._calc){ out.push(`Evento #${i+1}: ${e.tipo||"—"}`); out.push(JSON.stringify(e._calc, null, 2)); } }); const p = document.getElementById("rationalPanel"); p.textContent = out.join("\n"); } // Hook narrador pra espelhar cálculos quando ativo if(typeof NARRADOR!=="undefined"){ const _speak = NARRADOR.responder; NARRADOR.responder = function(ctx){ const chk = document.getElementById("chkRacional"); if(chk && chk.checked){ document.getElementById("rationalPanel").style.display="block"; showCalc(ctx); } else { document.getElementById("rationalPanel").style.display="none"; } return _speak.call(NARRADOR, ctx); } }
})(); /* ===== Armas: index default ===== */
(function ensureArmasIndex(){ const idx = readJSON("armas/index.json"); if(!idx){ writeJSON("armas/index.json", { ".38_Special": {"calibre_mm":9.07,"massa_g":10.2,"v0":260,"CdA":0.0005}, "12_Gauge": {"calibre_mm":18.53,"massa_g":32.0,"v0":380,"CdA":0.0020}, ".45_ACP": {"calibre_mm":11.43,"massa_g":15.0,"v0":285,"CdA":0.0008} }); }
})(); /* ===== PLANETA & DISTRITOS (escala mundial) ===== */
const PLANETA = (function(){ // lat/lon aproximadas e fuso; podem ser editadas no HD const base = { D1:{nome:"Distrito 1", lat:40.7128, lon:-74.0060, tz:"America/New_York", elev:10, bioma:"urbano-temperado"}, D2:{nome:"Distrito 2", lat:-23.5505,lon:-46.6333, tz:"America/Sao_Paulo", elev:760, bioma:"urbano-tropical"}, D3:{nome:"Distrito 3", lat:41.0082, lon:28.9784, tz:"Europe/Istanbul", elev:39, bioma:"industrial-costeiro"}, D4:{nome:"Distrito 4", lat:38.4237, lon:27.1428, tz:"Europe/Athens", elev:2, bioma:"semi-rural-medit"}, D5:{nome:"Distrito 5", lat:36.7213, lon:-4.4214, tz:"Europe/Madrid", elev:11, bioma:"costa-medit"}, D6:{nome:"Distrito 6", lat:-34.9011,lon:-56.1645, tz:"America/Montevideo",elev:43, bioma:"rural-pampa"}, D7:{nome:"Distrito 7", lat:-16.4897,lon:-68.1193, tz:"America/La_Paz", elev:3640,bioma:"montanha-andina"} }; function index(){ let idx = readJSON("distritos/index.json"); if(!idx) idx = {}; // merge sem sobrescrever leis existentes Object.keys(base).forEach(k=>{ idx[k] = Object.assign({}, base[k], idx[k]||{}); }); writeJSON("distritos/index.json", idx); return idx; } function distritoInfo(k){ const idx = readJSON("distritos/index.json")||{}; return idx[k]||null; } return {index, distritoInfo};
})();
(function(){ PLANETA.index(); })(); /* ===== Materiais, Estruturas e Colisões ===== */
const MATERIAIS = (function(){ const base = { "tecido": {dens:100, dureza:0.2, esp_mm:2}, "madeira": {dens:600, dureza:2.0, esp_mm:20}, "concreto": {dens:2400, dureza:6.0, esp_mm:120}, "aço": {dens:7850, dureza:9.0, esp_mm:5}, "vidro": {dens:2500, dureza:5.5, esp_mm:6}, "terra": {dens:1500, dureza:1.5, esp_mm:50}, "osso": {dens:1900, dureza:4.0, esp_mm:8}, "pele": {dens:1100, dureza:0.5, esp_mm:3} }; function index(){ let idx = readJSON("materiais/index.json"); if(!idx) idx = {}; Object.keys(base).forEach(k=>{ if(!idx[k]) idx[k]=base[k]; }); writeJSON("materiais/index.json", idx); return idx; } return {index};
})();
(function(){ MATERIAIS.index(); })(); const ESTRUTURAS = (function(){ function cargaColapso({material="concreto", area_m2=10, esp_mm=120}){ // proxy de resistência por material e espessura const m = (readJSON("materiais/index.json")||{})[material]||{dureza:4.0}; const k = (m.dureza||4.0) * (esp_mm/10); return k * area_m2 * 5e3; // N aproximados } // impacto em parede function impactoParede({energia_J=1000, material="concreto", area_m2=1, esp_mm=120}){ const col = cargaColapso({material, area_m2, esp_mm}); const dano = Math.min(1, energia_J/(col/50)); // 0 a 1 return {dano, colapso: dano>0.85}; } return {impactoParede, cargaColapso};
})(); const COLISOES = (function(){ // colisão elástica simplificada 1D para veículos/objetos function choque1D(m1,v1,m2,v2, e=0.35){ // e: coeficiente de restituição (0 inelástico, 1 elástico) const v1p = ( (m1-m2*e)*v1 + (1+e)*m2*v2 )/(m1+m2); const v2p = ( (m2-m1*e)*v2 + (1+e)*m1*v1 )/(m1+m2); return {v1p, v2p}; } return {choque1D};
})(); /* ===== Timestamp & Localização em toda narrativa ===== */
const CRONO = (function(){ // Marco 0: agora (ou do save), com base no fuso do distrito do personagem let baseEpoch = Date.now(); function now(){ return new Date(baseEpoch); } function advance(ms){ baseEpoch += ms; } function iso(dt){ return new Date(dt).toISOString(); } return {now, advance, iso};
})(); (function wireTimestamp(){ if(typeof NARRADOR==="undefined") return; const _responder = NARRADOR.responder; NARRADOR.responder = function(ctx){ // Determine distrito do evento const d = (ctx.local && ctx.local.distrito) || (window.__PERSONAGEM_ATIVO__ && window.__PERSONAGEM_ATIVO__.distrito) || "D1"; const info = (readJSON("distritos/index.json")||{})[d]||{nome:d, tz:"UTC"}; // timestamp simples (sem libs de tz): usamos ISO UTC + tag de tz para consistência const stamp = CRONO.iso(CRONO.now()); ctx.timestamp = {iso: stamp, distrito: d, tz: info.tz, local: info.nome}; // auto-avança ~ 10s por resposta CRONO.advance(10000); return _responder.call(NARRADOR, ctx); };
})(); /* ===== UI Status Mundial ===== */
(function worldStatusUI(){ const box = document.createElement("div"); box.style.position="fixed"; box.style.left="10px"; box.style.top="10px"; box.style.background="#121219"; box.style.color="#e8e8f5"; box.style.padding="6px 8px"; box.style.borderRadius="8px"; box.style.fontSize="12px"; box.style.opacity=".9"; box.style.zIndex="99990"; box.id="worldStatusBox"; document.body.appendChild(box); function tick(){ const d = (window.__PERSONAGEM_ATIVO__ && window.__PERSONAGEM_ATIVO__.distrito) || "D1"; const info = (readJSON("distritos/index.json")||{})[d]||{nome:d, tz:"UTC"}; const clima = (typeof CLIMA!=="undefined")?CLIMA.state().clima:{temp:0,vento:0,chuva:false,lua:"?"}; const nowIso = (function(){ try{ return new Date(CRONO.now()).toISOString(); }catch(e){ return ""; } })(); box.textContent = `${info.nome} • tz=${info.tz} • temp ${Math.round(clima.temp)}°C • vento ${Math.round(clima.vento)} m/s • chuva=${clima.chuva} • lua=${clima.lua} • ${nowIso}`; } setInterval(tick, 1000); tick();
})(); /* ===== Wire: física para prédios/veículos/personagens ===== */
(function wirePhysWorld(){ if(typeof RAZAO==="undefined") return; const _compose = RAZAO.composeCena; RAZAO.composeCena = function(ctx){ (ctx.eventos||[]).forEach(evt=>{ // impacto em parede/estrutura if(evt.impactoParede){ const r = ESTRUTURAS.impactoParede({ energia_J: evt.energia||1000, material: evt.material||"concreto", area_m2: evt.area||1, esp_mm: evt.esp_mm||120 }); evt._calc = evt._calc || {}; evt._calc.parede = r; if(r.colapso) ctx.flags = (ctx.flags||[]).concat(["colapso_estrutura"]); } // colisão veículo com objeto/veículo if(evt.colisao){ const r = COLISOES.choque1D(evt.m1||1500, evt.v1||0, evt.m2||100, evt.v2||0, evt.e||0.35); evt._calc = evt._calc || {}; evt._calc.colisao = r; evt.v1p = r.v1p; evt.v2p = r.v2p; } }); return _compose.call(RAZAO, ctx); }
})(); /* ===== Validador Mundial ===== */
(function worldValidator(){ const S = {falhas:0, correcoes:0}; function passo(){ let f=0, c=0; const D = readJSON("distritos/index.json")||{}; // leis mínimas em todos Object.keys(D).forEach(k=>{ if(!D[k].leis){ D[k].leis = {permite_porte:false, velocidade_max:60}; c++; } if(typeof D[k].leis.velocidade_max!=="number"){ D[k].leis.velocidade_max = 60; c++; } }); writeJSON("distritos/index.json", D); // ruas->casas coerentes const R = readJSON("ruas/index.json")||{}; const C = readJSON("casas/index.json")||{}; (Object.keys(R)||[]).forEach(dk=>{ Object.keys(R[dk]||{}).forEach(rua=>{ (R[dk][rua].casas||[]).forEach(cid=>{ if(!C[cid]){ C[cid] = {distrito:dk, rua:rua, arquitetura:"alvenaria"}; c++; } }); }); }); writeJSON("casas/index.json", C); // personagens com distrito default const idx = readJSON("personagens/index.json")||{}; Object.keys(idx).forEach(pid=>{ const path = `personagens/${pid}/identidade.json`; const p = readJSON(path)||{}; if(!p.distrito){ p.distrito = "D1"; c++; } writeJSON(path, p); }); S.falhas=f; S.correcoes+=c; if(c===0) { /* estável */ } } setInterval(passo, 250);
})(); /* ===== Formatação final da fala do narrador com timestamp/local ===== */
(function stampNarration(){ if(typeof NARRADOR==="undefined") return; const _render = NARRADOR.renderTexto; NARRADOR.renderTexto = function(ctx){ const t = ctx.timestamp || {}; const head = `[${t.iso||""} | ${t.local||""} ${t.tz?"("+t.tz+")":""}] `; ctx.texto = head + (ctx.texto||""); return _render.call(NARRADOR, ctx); }
})(); /* ===== Veículos & Classes ===== */
(function ensureVehicles(){ const idx = readJSON("veiculos/index.json")||{}; const base = { "Honda_HRV_2018": {classe:"SUV", massa:1320, area:2.2, Cd:0.34, Pmax:96000}, "Van_Comercial": {classe:"FURGAO", massa:1800, area:2.6, Cd:0.38, Pmax:110000}, "Caminhao_Leve": {classe:"TRUCK_LIGHT", massa:4800, area:5.0, Cd:0.6, Pmax:150000} }; Object.keys(base).forEach(k=>{ if(!idx[k]) idx[k]=base[k]; }); writeJSON("veiculos/index.json", idx);
})(); /* ===== Patch armas: Thompson .45 e 12 Gauge detalhadas ===== */
(function patchArmas(){ const idx = readJSON("armas/index.json")||{}; idx["Thompson_45ACP"] = idx["Thompson_45ACP"] || {"calibre_mm":11.43,"massa_g":15.0,"v0":285,"CdA":0.0008}; idx["Doze_12Gauge"] = idx["Doze_12Gauge"] || {"calibre_mm":18.53,"massa_g":32.0,"v0":380,"CdA":0.0020}; writeJSON("armas/index.json", idx);
})(); /* ===== Tigre world patch ===== */
(function patchTigreWorld(){ const path = "personagens/P001_Tigre/identidade.json"; const id = readJSON(path)||{}; if(!id.veiculo){ id.veiculo = "Honda_HRV_2018"; } if(!id.distrito){ id.distrito = "D1"; } id.meta = {destino:"D4", rua:"Rua do Tigre", casa:"47_pos_ponte"}; writeJSON(path, id); window.__PERSONAGEM_ATIVO__ = Object.assign({id:"P001_Tigre", nome:"Tigre"}, id);
})(); /* ===== Distrito: offset_hours para hora local aproximada ===== */
(function patchTZ(){ const D = readJSON("distritos/index.json")||{}; const offs = { "America/New_York": -4, "America/Sao_Paulo": -3, "Europe/Istanbul": 3, "Europe/Athens": 3, "Europe/Madrid": 2, "America/Montevideo": -3, "America/La_Paz": -4, "UTC": 0 }; Object.keys(D).forEach(k=>{ if(typeof D[k].offset_hours!=="number"){ const tz = D[k].tz||"UTC"; D[k].offset_hours = (offs[tz]!=null)?offs[tz]:0; } }); writeJSON("distritos/index.json", D);
})(); /* ===== Hora local amigável ===== */
function localTimeString(iso, tzinfo){ try{ const d = new Date(iso); const off = (tzinfo && typeof tzinfo.offset_hours==="number")? tzinfo.offset_hours : 0; const ms = d.getTime() + off*3600*1000; const dl = new Date(ms); const pad = n=> (n<10?"0":"")+n; return `${dl.getFullYear()}-${pad(dl.getMonth()+1)}-${pad(dl.getDate())} ${pad(dl.getHours())}:${pad(dl.getMinutes())}:${pad(dl.getSeconds())}`; }catch(e){ return iso; }
} /* ===== Narrativa cabeçalho com hora local ===== */
(function headerLocal(){ if(typeof NARRADOR==="undefined") return; const _render = NARRADOR.renderTexto; NARRADOR.renderTexto = function(ctx){ const t = ctx.timestamp || {}; const D = readJSON("distritos/index.json")||{}; const info = D[t.distrito||"D1"]||{tz:"UTC",offset_hours:0,nome:t.distrito||"?"}; const localStr = localTimeString(t.iso, info); const head = `[${localStr} ${info.tz} | ${info.nome}] `; ctx.texto = head + (ctx.texto||""); return _render.call(NARRADOR, ctx); }
})(); /* ===== Personalizar Resposta: validação por alcance e recursos ===== */
const IMPROV = (function(){ // Configs padrão do ator const cfg = {alcance_m: 2.0, vel_andar:1.5, vel_correr:4.5}; function pesoInventarioKg(actor){ const inv = (actor&&actor.inventario)||[]; let w=0; inv.forEach(i=>{ w += (i.peso_kg||0)*(i.qtd||1); }); return w; } function velEfetiva(actor, correr=false){ const base = correr?cfg.vel_correr:cfg.vel_andar; const carga = pesoInventarioKg(actor); const pen = Math.max(0.6, 1 - (carga/40)); // 40kg saturação return base*pen; } function dist(a,b){ const dx=(a.x-b.x), dy=(a.y-b.y); return Math.sqrt(dx*dx+dy*dy); } function findItensNoRaio(ctx, r){ const it = ((ctx.ambiente&&ctx.ambiente.itens)||[]).concat([]); const pos = (ctx.actor&&ctx.actor.pos)||{x:0,y:0}; return it.filter(o=> dist(pos, o.pos||{x:0,y:0}) <= r ); } function procurarItem(ctx, nome){ const it = (ctx.ambiente&&ctx.ambiente.itens)||[]; let best=null, bestd=1e9, pos=(ctx.actor&&ctx.actor.pos)||{x:0,y:0}; it.forEach(o=>{ if((o.nome||"").toLowerCase().includes(nome.toLowerCase())){ const d = dist(pos, o.pos||{x:0,y:0}); if(d<bestd){ best=o; bestd=d; } } }); return {alvo:best, d:bestd}; } function correrAte(ctx, alvo){ const a = ctx.actor||{pos:{x:0,y:0}}; const v = velEfetiva(a, true); const d = dist(a.pos||{x:0,y:0}, alvo.pos||{x:0,y:0}); const t = d/Math.max(0.1, v); // s // custo: avanço de tempo e fadiga simples CRONO.advance(Math.round(t*1000)); a.fadiga = Math.min(1, (a.fadiga||0) + t/1200); // 20 min de corrida ~ fadiga 1.0 a.pos = {x:alvo.pos.x, y:alvo.pos.y}; ctx.eventos = (ctx.eventos||[]).concat([{tipo:"movimento", corrida:true, dist_m:d, tempo_s:t}]); } function executar(ctx, texto){ // parsing simples: procurar verbo e objeto const m = texto.toLowerCase().match(/(pegar|usar|arremessar|jogar|atirar|empurrar|quebrar|cortar|acender)\s+(.+)/); let verbo = m?m[1]:null; let objeto = m?m[2]:texto; const alcance = cfg.alcance_m; const actor = ctx.actor || {pos:{x:0,y:0}}; // se objeto faz referência a algo do inventário, sempre permitido const inv = (actor.inventario||[]); const inInv = inv.find(i => (i.nome||"").toLowerCase().includes(objeto.toLowerCase())); if(inInv){ return {ok:true, acao:{verbo, objeto, origem:"inventario", custo:0}}; } // buscar item no cenário const {alvo, d} = procurarItem(ctx, objeto); if(!alvo){ return {ok:false, motivo:"objeto_inexistente_ou_fora_do_cenario"}; } if(d<=alcance){ return {ok:true, acao:{verbo, objeto:alvo.nome, origem:"raio", custo:0, d}}; } // fora do alcance → correr automaticamente correrAte(ctx, alvo); return {ok:true, acao:{verbo, objeto:alvo.nome, origem:"corrido", custo:d, d}}; } return {executar, findItensNoRaio};
})(); /* ===== UI: botão Personalize sua resposta ===== */
(function personalizeUI(){ const btn = document.createElement("button"); btn.textContent = "Personalize sua resposta"; btn.style.position="fixed"; btn.style.right="10px"; btn.style.bottom="10px"; btn.style.padding="10px 12px"; btn.style.borderRadius="10px"; btn.style.background="#1f2740"; btn.style.color="#eaf1ff"; btn.style.border="1px solid #3a4b7a"; btn.style.zIndex="99997"; btn.style.cursor="pointer"; document.body.appendChild(btn); const overlay = document.createElement("div"); overlay.style.position="fixed"; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0; overlay.style.background="rgba(0,0,0,.6)"; overlay.style.display="none"; overlay.style.zIndex="99998"; const pane = document.createElement("div"); pane.style.position="absolute"; pane.style.left="50%"; pane.style.top="50%"; pane.style.transform="translate(-50%,-50%)"; pane.style.background="#0e0f15"; pane.style.color="#e8ecff"; pane.style.padding="16px"; pane.style.borderRadius="12px"; pane.style.width="min(92vw,520px)"; pane.innerHTML = `<h3 style="margin-top:0">Personalizar ação</h3><p>Descreva sua ação. Ela será validada pelos recursos no seu raio de alcance, tempo e física do mundo.</p><input id="improvText" style="width:100%;padding:10px;border-radius:8px;border:1px solid #3a4b7a;background:#0b0c12;color:#e8ecff" placeholder="ex.: pegar machado e cortar a tranca"><div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end"><button id="improvCancel" style="padding:8px 10px;border-radius:8px;border:1px solid #555;background:#191b2a;color:#ddd">Cancelar</button><button id="improvGo" style="padding:8px 10px;border-radius:8px;border:1px solid #5aa4ff;background:#1f4e7a;color:#e8f2ff">Executar</button></div>`; overlay.appendChild(pane); document.body.appendChild(overlay); btn.onclick = ()=>{ overlay.style.display="block"; setTimeout(()=>{ document.getElementById("improvText").focus(); },10); }; pane.querySelector("#improvCancel").onclick = ()=> overlay.style.display="none"; pane.querySelector("#improvGo").onclick = ()=>{ const txt = pane.querySelector("#improvText").value.trim(); overlay.style.display="none"; if(!txt) return; // Monta um ctx corrente mínimo a partir do pipeline const ctx = window.__CTX_ATUAL__ ? JSON.parse(JSON.stringify(window.__CTX_ATUAL__)) : {actor:window.__PERSONAGEM_ATIVO__||{}, ambiente:{itens:[]}, eventos:[]}; const r = IMPROV.executar(ctx, txt); // Enriquecer narrativa com resultado e cálculos if(!r.ok){ NARRADOR.responder({texto:`Ação rejeitada: ${r.motivo}.`, eventos:ctx.eventos, local:{distrito:(ctx.local&&ctx.local.distrito)||"D1"}}); return; } // Criar evento de ação para o pipeline/RAZAO ctx.eventos = (ctx.eventos||[]).concat([{tipo:"personalizada", detalhe:r.acao, texto:txt}]); ctx.texto = `Tentativa: ${txt} → ok (${r.acao.origem}${r.acao.d?`, dist=${r.acao.d.toFixed(1)}m`:``}).`; ctx.local = ctx.local || {distrito: (window.__PERSONAGEM_ATIVO__&&window.__PERSONAGEM_ATIVO__.distrito)||"D1"}; window.__CTX_ATUAL__ = ctx; // memoriza NARRADOR.responder(ctx); };
})(); /* ===== Tap do contexto atual ===== */
(function tapCtx(){ if(typeof NARRADOR==="undefined") return; const _responder = NARRADOR.responder; NARRADOR.responder = function(ctx){ window.__CTX_ATUAL__ = JSON.parse(JSON.stringify(ctx||{})); return _responder.call(NARRADOR, ctx); }
})(); /* ===== Itens padrão de cena (se não houver) ===== */
(function fallbackItems(){ const _compose = RAZAO.composeCena; RAZAO.composeCena = function(ctx){ ctx.ambiente = ctx.ambiente || {}; if(!Array.isArray(ctx.ambiente.itens) || ctx.ambiente.itens.length===0){ ctx.ambiente.itens = [ {nome:"pedra média", material:"rocha", pos:{x:1.2,y:0.5}, peso_kg:0.8}, {nome:"galho seco", material:"madeira", pos:{x:2.0,y:-0.3}, peso_kg:0.3}, {nome:"machado velho", material:"aço", pos:{x:9.5,y:1.4}, peso_kg:2.5}, {nome:"garrafa vazia", material:"vidro", pos:{x:1.7,y:0.2}, peso_kg:0.2} ]; } ctx.actor = ctx.actor || {}; ctx.actor.pos = ctx.actor.pos || {x:0,y:0}; ctx.actor.inventario = ctx.actor.inventario || []; return _compose.call(RAZAO, ctx); }
})(); /* ===== DetailGuard: tudo entra detalhado, não só tópicos ===== */
(function detailGuardInstall(){ if(window.__WRITEJSON_ORIG__) return; window.__WRITEJSON_ORIG__ = window.writeJSON; function richenPersonagem(obj){ obj = obj||{}; obj.nome = obj.nome || "SemNome"; obj.idade = (typeof obj.idade==="number")? obj.idade : 27; obj.sexo = obj.sexo || "indef"; obj.distrito = obj.distrito || "D1"; obj.aparencia = obj.aparencia || { altura_m: 1.70, peso_kg: 70, olhos:"castanhos", cabelos:"castanhos", pele:"morena", marcas:[], estilo:"casual", sex_appeal:0.5 }; obj.personalidade = obj.personalidade || {traços:["resoluto"], defeitos:["impulsivo"], virtudes:["leal"]}; obj.afinidades = obj.afinidades || {família:0.8, lealdade:0.7, risco:0.6}; obj.inventario = obj.inventario || []; obj.pos = obj.pos || {x:0,y:0}; obj.classes = obj.classes || ["HUMANO"]; return obj; } function richenCasa(obj, k){ obj = obj||{}; obj.arquitetura = obj.arquitetura || "alvenaria"; obj.comodos = obj.comodos || ["sala","cozinha","quarto"]; obj.material = obj.material || "concreto"; obj.distrito = obj.distrito || "D1"; obj.rua = obj.rua || "SemRua"; obj.numero = obj.numero || (k||"S/N"); return obj; } function richenRua(obj){ obj = obj||{}; obj.nome = obj.nome || "Rua Sem Nome"; obj.casas = obj.casas || []; return obj; } function richenDistrito(obj){ obj = obj||{}; obj.tz = obj.tz || "UTC"; obj.offset_hours = (typeof obj.offset_hours==="number")?obj.offset_hours:0; obj.leis = obj.leis || {permite_porte:false, velocidade_max:60}; obj.bioma = obj.bioma || "urbano"; return obj; } function deepDetail(path, data){ // aplica enriquecimento por domínio if(path.startsWith("personagens/") && path.endsWith("/identidade.json")){ data = richenPersonagem(data); }else if(path==="casas/index.json"){ const out={}; Object.keys(data||{}).forEach(k=> out[k]=richenCasa(data[k], k)); data=out; }else if(path==="ruas/index.json"){ const out={}; Object.keys(data||{}).forEach(dk=>{ out[dk]=out[dk]||{}; Object.keys(data[dk]||{}).forEach(rn=>{ out[dk][rn]=richenRua(data[dk][rn]); }); }); data=out; }else if(path=="distritos/index.json"){ const out={}; Object.keys(data||{}).forEach(k=> out[k]=richenDistrito(data[k])); data=out; } return data; } window.writeJSON = function(path, data){ try{ data = deepDetail(path, data); }catch(e){ console.warn("DetailGuard error", e); } return window.__WRITEJSON_ORIG__(path, data); };
})(); /* ===== Autosave a cada 2 escolhas + Export/Import ===== */
(function autosave(){ window.__CHOICE_COUNT__ = window.__CHOICE_COUNT__||0; function saveNow(label){ const hd = dumpFS(); // função do FS virtual já existente const stamp = new Date().toISOString(); const pack = {stamp, hd, personagem:(window.__PERSONAGEM_ATIVO__||{}).id||null}; localStorage.setItem("CORPO_AUTOSAVE", JSON.stringify(pack)); // também registra em HD writeJSON("saves/autosave.json", pack); if(label){ console.log("Autosave:", label, stamp); } } // hook narrador para contar escolhas if(typeof NARRADOR!=="undefined"){ const _responder = NARRADOR.responder; NARRADOR.responder = function(ctx){ window.__CHOICE_COUNT__ = (window.__CHOICE_COUNT__||0)+1; if(window.__CHOICE_COUNT__ % 2 === 0) saveNow("choice#"+window.__CHOICE_COUNT__); return _responder.call(NARRADOR, ctx); }; } // UI Export/Import const bar = document.createElement("div"); bar.style.position="fixed"; bar.style.right="10px"; bar.style.top="10px"; bar.style.display="flex"; bar.style.gap="6px"; bar.style.zIndex="99996"; const btnExp = document.createElement("button"); btnExp.textContent="Exportar Save"; const btnImp = document.createElement("button"); btnImp.textContent="Importar Save"; [btnExp,btnImp].forEach(b=>{ b.style.padding="6px 8px"; b.style.borderRadius="8px"; b.style.border="1px solid #3a4b7a"; b.style.background="#18213a"; b.style.color="#e8f2ff"; }); bar.appendChild(btnExp); bar.appendChild(btnImp); document.body.appendChild(bar); btnExp.onclick = ()=>{ const pack = localStorage.getItem("CORPO_AUTOSAVE") || JSON.stringify({stamp:new Date().toISOString(), hd:dumpFS()}); const a = document.createElement("a"); const blob = new Blob([pack], {type:"application/json"}); a.href = URL.createObjectURL(blob); a.download = "save_corpo_autosave.json"; a.click(); }; btnImp.onclick = ()=>{ const inp = document.createElement("input"); inp.type="file"; inp.accept="application/json"; inp.onchange = ()=>{ const file = inp.files[0]; if(!file) return; const fr = new FileReader(); fr.onload = ()=>{ try{ const pack = JSON.parse(fr.result); if(pack.hd) { loadFS(pack.hd); localStorage.setItem("CORPO_AUTOSAVE", JSON.stringify(pack)); alert("Save importado."); location.reload(); } }catch(e){ alert("Falha ao importar."); } }; fr.readAsText(file); }; inp.click(); };
})(); /* ===== Loop de análise+correção ===== */
const INSPECTOR = (function(){ const S = {erros:0, correcoes:0, sugestoes:0, rodadas:0, last:[]}; function addFail(msg, fix){ S.erros++; S.last.push({tipo:"erro", msg}); if(fix){ fix(); S.correcoes++; } } function addSug(msg, fix){ S.sugestoes++; S.last.push({tipo:"sugestao", msg}); if(fix){ fix(); } } function scan(){ S.erros=0; S.correcoes=0; S.sugestoes=0; S.rodadas++; const D = readJSON("distritos/index.json")||{}; const R = readJSON("ruas/index.json")||{}; const C = readJSON("casas/index.json")||{}; const P = readJSON("personagens/index.json")||{}; // 1) Distrito coerente Object.keys(D).forEach(k=>{ if(!D[k].leis) addFail(`Distrito ${k} sem leis`, ()=>{ D[k].leis={permite_porte:false,velocidade_max:60}; }); if(typeof D[k].offset_hours!=="number") addFail(`Distrito ${k} sem offset_hours`, ()=>{ D[k].offset_hours=0; }); }); // 2) Ruas→Casas consistentes Object.keys(R).forEach(dk=>{ Object.keys(R[dk]||{}).forEach(rua=>{ const arr = (R[dk][rua].casas||[]); arr.forEach(cid=>{ if(!C[cid]) addFail(`Casa ${cid} citada em ${rua}/${dk} inexistente`, ()=>{ C[cid] = {distrito:dk, rua, arquitetura:"alvenaria", numero:cid.split("_").pop()||"S/N"}; }); }); }); }); // 3) Personagens completos Object.keys(P).forEach(pid=>{ const path = `personagens/${pid}/identidade.json`; let id = readJSON(path) || {}; if(!id.nome) addFail(`Personagem ${pid} sem nome`, ()=>{ id.nome=pid; }); if(!id.distrito) addFail(`Personagem ${pid} sem distrito`, ()=>{ id.distrito="D1"; }); if(!id.aparencia) addSug(`Personagem ${pid} sem aparência`, ()=>{ id.aparencia={altura_m:1.70,peso_kg:70,olhos:"castanhos",cabelos:"castanhos",pele:"morena",sex_appeal:0.5}; }); writeJSON(path, id); }); // 4) Itens de cena com peso/material const I = readJSON("itens/index.json")||{}; Object.keys(I).forEach(k=>{ if(typeof I[k].peso_kg!=="number") addSug(`Item ${k} sem peso`, ()=>{ I[k].peso_kg=0.5; }); if(!I[k].material) addSug(`Item ${k} sem material`, ()=>{ I[k].material="madeira"; }); }); writeJSON("itens/index.json", I); // commit distritos/casas se alterados writeJSON("distritos/index.json", D); writeJSON("casas/index.json", C); return S; } function runUntilStable(limit=50){ let i=0, s=null; do { s = scan(); i++; } while((s.erros>0 || s.correcoes>0) && i<limit); return s; } return {scan, runUntilStable, state:()=>S};
})(); (function bootLoop(){ const box = document.createElement("div"); box.style.position="fixed"; box.style.left="10px"; box.style.bottom="10px"; box.style.padding="6px 8px"; box.style.background="#102015"; box.style.color="#bdf7cb"; box.style.border="1px solid #2e6d3a"; box.style.borderRadius="8px"; box.style.zIndex="99995"; document.body.appendChild(box); function tick(){ const s = INSPECTOR.runUntilStable(5); box.textContent = `Analisador: erros=${s.erros} • correções+=${s.correcoes} • sugestões=${s.sugestoes} • rodada=${s.rodadas}`; } setInterval(tick, 1200); tick();
})(); /* ===== Grandezas (SI) — núcleo ===== */
const U = (function(){ // Base dimensions vector: [L, M, T, I, Θ, N, J] function V(L=0,M=0,T=0,I=0,Th=0,N=0,J=0){ return [L,M,T,I,Th,N,J]; } const BASE = { m: {k:1, dim:V(1,0,0,0,0,0,0)}, // meter kg: {k:1, dim:V(0,1,0,0,0,0,0)}, // kilogram s: {k:1, dim:V(0,0,1,0,0,0,0)}, // second A: {k:1, dim:V(0,0,0,1,0,0,0)}, // ampere K: {k:1, dim:V(0,0,0,0,1,0,0)}, // kelvin mol:{k:1, dim:V(0,0,0,0,0,1,0)}, // mole cd: {k:1, dim:V(0,0,0,0,0,0,1)} // candela }; const REG = { // base & multiples m: BASE.m, km:{k:1000, dim:BASE.m.dim}, cm:{k:0.01, dim:BASE.m.dim}, mm:{k:0.001, dim:BASE.m.dim}, kg: BASE.kg, g:{k:0.001, dim:BASE.kg.dim}, s: BASE.s, ms:{k:0.001, dim:BASE.s.dim}, min:{k:60, dim:BASE.s.dim}, h:{k:3600, dim:BASE.s.dim}, A: BASE.A, K: BASE.K, mol: BASE.mol, cd: BASE.cd, // derived Hz:{k:1, dim:V(0,0,-1,0,0,0,0)}, N: {k:1, dim:V(1,1,-2,0,0,0,0)}, // kg·m/s^2 Pa:{k:1, dim:V(-1,1,-2,0,0,0,0)}, // N/m^2 J: {k:1, dim:V(2,1,-2,0,0,0,0)}, // N·m W: {k:1, dim:V(2,1,-3,0,0,0,0)}, // J/s 'm/s': {k:1, dim:V(1,0,-1,0,0,0,0)}, 'm/s2':{k:1, dim:V(1,0,-2,0,0,0,0)}, 'kg/m3':{k:1, dim:V(-3,1,0,0,0,0,0)}, 'J/kg':{k:1, dim:V(2,0,-2,0,0,0,0)}, }; // human-friendly aliases REG['m³'] = REG['m3'] = {k:1, dim:V(3,0,0,0,0,0,0)}; REG['kg/m³'] = REG['kg/m3']; function dimEq(a,b){ return a.length===b.length && a.every((x,i)=> x===b[i]); } class Q { constructor(value, unit){ if(unit && !REG[unit]) throw new Error("Unidade desconhecida: "+unit); this.valueSI = unit ? value * REG[unit].k : value; this.dim = unit ? REG[unit].dim.slice() : V(0,0,0,0,0,0,0); } to(unit){ if(!REG[unit]) throw new Error("Unidade desconhecida: "+unit); if(!dimEq(this.dim, REG[unit].dim)) throw new Error("Dimensão incompatível"); return this.valueSI / REG[unit].k; } add(q){ if(!dimEq(this.dim, q.dim)) throw new Error("Dimensão incompatível"); this.valueSI += q.valueSI; return this; } sub(q){ if(!dimEq(this.dim, q.dim)) throw new Error("Dimensão incompatível"); this.valueSI -= q.valueSI; return this; } mul(q){ const out = new Q(this.valueSI * q.valueSI); out.dim = this.dim.map((d,i)=> d + q.dim[i]); return out; } div(q){ const out = new Q(this.valueSI / q.valueSI); out.dim = this.dim.map((d,i)=> d - q.dim[i]); return out; } scale(k){ const out = new Q(this.valueSI); out.dim = this.dim.slice(); out.valueSI*=k; return out; } } function q(value, unit){ return new Q(value, unit); } // Constantes const g0 = q(9.80665, 'm/s2'); const rho_ar = q(1.225, 'kg/m3'); // 15°C, nível do mar const c = q(299792458, 'm/s'); // Utilidades function energiaCinetica(m_kg, v_ms){ return q(m_kg,'kg').mul(q(v_ms,'m/s')).mul(q(v_ms,'m/s')); } // 0.5? adotamos depois function momentum(m_kg, v_ms){ return q(m_kg,'kg').mul(q(v_ms,'m/s')); } return {Q, q, REG, BASE, g0, rho_ar, c, energiaCinetica, momentum, dimEq};
})(); /* ===== Painel de Grandezas ===== */
(function GrandezasPanel(){ const box = document.createElement("div"); box.id="grandezasBox"; box.style.position="fixed"; box.style.left="10px"; box.style.top="50px"; box.style.background="#101722"; box.style.color="#e9f1ff"; box.style.border="1px solid #2a3c5c"; box.style.borderRadius="8px"; box.style.padding="8px 10px"; box.style.zIndex="99990"; box.style.minWidth="260px"; box.style.fontSize="12px"; box.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><strong>Grandezas (SI)</strong><label style="margin-left:auto;display:flex;align-items:center;gap:6px;"><span style="opacity:.8">mostrar</span><input id="gShow" type="checkbox" checked></label></div><div id="gBody" style="margin-top:6px;max-height:28vh;overflow:auto;line-height:1.2"></div>`; document.body.appendChild(box); const chk = box.querySelector("#gShow"); const body = box.querySelector("#gBody"); function fmt(v, unit){ try{ return `${v.toFixed(2)} ${unit}`; }catch(e){ return `${v} ${unit}`; } } function render(){ if(!chk.checked){ body.innerHTML="(oculto)"; return; } try{ const a = window.__PERSONAGEM_ATIVO__||{}; const mass = (a.aparencia&&a.aparencia.peso_kg)||70; const v = (a.vel_ms)||0; const Ek = 0.5 * mass * v*v; // J const p = mass * v; // kg·m/s const tempK = (window.__AMBIENTE__&&window.__AMBIENTE__.tempK)|| 293.15; const pressPa = (window.__AMBIENTE__&&window.__AMBIENTE__.pressPa)|| 101325; const speed = v * 3.6; body.innerHTML = [ `massa personagem: ${fmt(mass, "kg")}`, `velocidade: ${fmt(v,"m/s")} (${fmt(speed,"km/h")})`, `momento linear: ${fmt(p,"kg·m/s")}`, `energia cinética: ${fmt(Ek,"J")}`, `temperatura: ${fmt(tempK,"K")}`, `pressão: ${fmt(pressPa,"Pa")}` ].join("<br>"); }catch(e){ body.innerHTML = "(sem dados)"; } } setInterval(render, 800); render();
})(); /* ===== Hooks de Grandezas nas físicas ===== */
(function HookGrand(){ // Se BALISTICA existir, ajusta para checar dimensão de entrada (massa e velocidade) if(typeof BALISTICA!=="undefined"){ const _impacto = BALISTICA.calcImpacto; BALISTICA.calcImpacto = function(proj){ // enriquece com grandezas SI if(proj && typeof proj.massa_kg==="number" && typeof proj.v_ms==="number"){ proj._Q = { massa: U.q(proj.massa_kg, 'kg'), vel: U.q(proj.v_ms, 'm/s'), energia: U.energiaCinetica(proj.massa_kg, proj.v_ms).scale(0.5) // 1/2 m v^2 }; } return _impacto.call(BALISTICA, proj); } } // Se VEICULOS existir, marca velocidade em m/s para painel if(window.__PERSONAGEM_ATIVO__){ window.__PERSONAGEM_ATIVO__.vel_ms = window.__PERSONAGEM_ATIVO__.vel_ms || 0; }
})(); /* ===== Materiais com unidades ===== */
(function enrichMateriais(){ const M = readJSON("materiais/index.json")||{}; Object.keys(M).forEach(k=>{ const m = M[k]; if(typeof m.densidade==="number" && !m._u){ // marca que já converteu m._u = {}; m._u.densidade = "kg/m3"; // valores típicos se faltarem if(typeof m.E_GPa!=="number") m.E_GPa = 20; // módulo de elasticidade ~fallback if(typeof m.limite_escoamento_MPa!=="number") m.limite_escoamento_MPa = 250; } }); writeJSON("materiais/index.json", M);
})(); /* ===== Inspector: sugestões de unidades faltantes ===== */
(function inspUnits(){ if(typeof INSPECTOR==="undefined") return; const _scan = INSPECTOR.scan; INSPECTOR.scan = function(){ const S = _scan(); const M = readJSON("materiais/index.json")||{}; Object.keys(M).forEach(k=>{ const m = M[k]; if(m && typeof m.densidade==="number" && (!m._u || !m._u.densidade)){ S.sugestoes++; S.last.push({tipo:"sugestao", msg:`Material ${k} sem unidade de densidade`}); m._u = m._u || {}; m._u.densidade = "kg/m3"; } }); writeJSON("materiais/index.json", M); return S; };
})(); /* ===== Conversor de Unidades (UI) ===== */
(function UnitConverter(){ const wrap = document.createElement("div"); wrap.style.position="fixed"; wrap.style.right="10px"; wrap.style.top="50px"; wrap.style.zIndex="99991"; wrap.style.background="#0f1220"; wrap.style.color="#eaf1ff"; wrap.style.border="1px solid #2c3e72"; wrap.style.borderRadius="8px"; wrap.style.padding="8px 10px"; wrap.style.minWidth="260px"; wrap.innerHTML = `<div style="display:flex;gap:6px;align-items:center"><strong>Conversor</strong><span style="opacity:.7">(ex.: 20 km/h → m/s)</span></div><input id="ucIn" placeholder="digite valor e unidade" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;border:1px solid #3a4b7a;background:#0b0c12;color:#e8ecff"><div id="ucOut" style="margin-top:6px;line-height:1.2;min-height:1.2em"></div>`; document.body.appendChild(wrap); const $in = wrap.querySelector("#ucIn"), $out = wrap.querySelector("#ucOut"); function norm(u){return u.replace(/·/g,"*").replace(/\s+/g,"").replace(/per/,"/");} function solve(v,u){ try{ // casos especiais tratados if(/km\/h/i.test(u)) { // velocidade const ms = parseFloat(v) * 1000/3600; return `${v} km/h = ${ms.toFixed(3)} m/s`; } if(/c$/i.test(u.trim())){ // múltiplos da velocidade da luz const k = parseFloat(v); const ms = k * U.c.valueSI; return `${v} c = ${ms.toFixed(0)} m/s`; } // unidades diretas registradas em U.REG if(U.REG[u]){ const x = new U.Q(parseFloat(v), u); return `${v} ${u} = ${x.to( Object.keys(U.REG).includes("m") ? "m":u)} (dim=${U.REG[u].dim.join(",")})`; } // parsing simples "valor unidade_base" const m = u.match(/^([a-zA-Z]+)$/); if(m && U.REG[m[1]]){ const x = new U.Q(parseFloat(v), m[1]); return `${v} ${m[1]} (SI ok)`; } return "Unidade não reconhecida."; }catch(e){ return "Erro: "+e.message; } } $in.addEventListener("input", ()=>{ const txt = $in.value.trim(); const mm = txt.match(/^([\-\d\.]+)\s*(.+)$/); if(!mm){ $out.textContent=""; return; } const v = mm[1]; const u = norm(mm[2]); $out.textContent = solve(v,u); });
})(); /* ===== Grandezas extras & Painel de Forças ===== */
(function ForcesPanel(){ // parâmetros padrão do ambiente/contato const params = { mu: 0.6, // atrito estático aprox. CdA: 0.7, // coef arrasto * área (humano em m^2) rho: U.rho_ar.valueSI // densidade ar SI }; const box = document.createElement("div"); box.style.position="fixed"; box.style.left="10px"; box.style.top="230px"; box.style.zIndex="99989"; box.style.background="#101a13"; box.style.color="#d9ffe5"; box.style.border="1px solid #2d6c44"; box.style.borderRadius="8px"; box.style.padding="8px 10px"; box.style.minWidth="260px"; box.innerHTML = `<div style="display:flex;gap:6px;align-items:center"><strong>Forças</strong><span style="opacity:.75">(peso/normal/atrito/arrasto)</span></div><div id="forcesOut" style="margin-top:6px;line-height:1.2"></div>`; document.body.appendChild(box); const out = box.querySelector("#forcesOut"); function fmt(x){ return (Math.round(x*100)/100).toFixed(2); } setInterval(()=>{ try{ const a = window.__PERSONAGEM_ATIVO__||{}; const m = (a.aparencia&&a.aparencia.peso_kg)||70; const v = a.vel_ms||0; const g = U.g0.valueSI; const Fg = m*g; const N = Fg; // plano horizontal ideal const Fa = 0.5*params.rho*params.CdA*v*v; const Fat = params.mu * N; out.innerHTML = [ `peso: ${fmt(Fg)} N`, `normal: ${fmt(N)} N`, `arrasto (v): ${fmt(Fa)} N`, `atrito máx.: ${fmt(Fat)} N` ].join("<br>"); }catch(e){ out.textContent="(sem dados)"; } }, 900);
})(); /* ===== Métricas perceptuais & consumo ===== */
(function perceptual(){ const box = document.createElement("div"); box.style.position="fixed"; box.style.right="10px"; box.style.top="180px"; box.style.zIndex="99988"; box.style.background="#18120f"; box.style.color="#ffe9d9"; box.style.border="1px solid #6c3d2d"; box.style.borderRadius="8px"; box.style.padding="8px 10px"; box.style.minWidth="260px"; box.innerHTML = `<div style="display:flex;gap:6px;align-items:center"><strong>Métricas</strong><span style="opacity:.7">(dB, lux, consumo)</span></div><div id="metOut" style="margin-top:6px;line-height:1.2"></div>`; document.body.appendChild(box); const out = box.querySelector("#metOut"); setInterval(()=>{ try{ const amb = window.__AMBIENTE__||{}; const ruido_dB = typeof amb.ruido_dB==="number" ? amb.ruido_dB : 45; // sala silenciosa const lux = typeof amb.lux==="number" ? amb.lux : 150; // interior const veh = window.__VEICULO_ATIVO__||{}; const kmh = veh.vel_kmh||0, l100 = veh.consumo_L_100km||8.5; const kml = l100>0? (100.0/l100):0; out.innerHTML = [ `ruído: ${ruido_dB} dB`, `iluminância: ${lux} lux`, `veículo: ${kmh||0} km/h | consumo: ${l100} L/100km ` + (kml>0 ? (Math.round(1000*kml)/1000) : 0) + ` km/L)` ].join("<br>"); }catch(e){ out.textContent="(sem dados)"; } }, 1000);
})(); /* ===== Inspector: árvore de causas (log detalhado) ===== */
(function inspTree(){ if(typeof INSPECTOR==="undefined") return; const pane = document.createElement("div"); pane.style.position="fixed"; pane.style.left="10px"; pane.style.bottom="60px"; pane.style.zIndex="99987"; pane.style.background="#0f0f10"; pane.style.color="#e6e6ea"; pane.style.border="1px solid #3a3a48"; pane.style.borderRadius="8px"; pane.style.padding="6px 8px"; pane.style.minWidth="260px"; pane.style.maxHeight="26vh"; pane.style.overflow="auto"; pane.style.fontSize="11px"; pane.innerHTML = `<div style="display:flex;gap:6px;align-items:center"><strong>Inspector (causas)</strong><button id="itClear" style="margin-left:auto;padding:3px 6px;border-radius:6px;border:1px solid #444;background:#181820;color:#ddd">limpar</button></div><div id="itLog" style="margin-top:6px;white-space:pre-wrap"></div>`; document.body.appendChild(pane); const log = pane.querySelector("#itLog"); pane.querySelector("#itClear").onclick = ()=> log.textContent=""; const _scan = INSPECTOR.scan; INSPECTOR.scan = function(){ const S = _scan(); const L = (INSPECTOR.state().last||[]).slice(-10); L.forEach(e=>{ const tag = e.tipo==="erro" ? "[!]" : "[>]"; log.textContent += `${tag} ${e.msg}\n`; }); return S; };
})(); /* ===== WorldMap: distritos planetários e rotas ===== */
const WORLD = (function(){ const distritos = readJSON("distritos/index.json") || {}; // fallback de distâncias aproximadas entre distritos (km) const rotas = readJSON("distritos/rotas.json") || { D1:{D2:12, D3:38, D4:75, D5:140}, D2:{D1:12, D3:24, D4:60}, D3:{D1:38, D2:24, D4:30, D5:90}, D4:{D1:75, D2:60, D3:30, D5:45}, D5:{D1:140, D3:90, D4:45, D6:110}, D6:{D5:110, D7:80}, D7:{D6:80} }; // velocidade média por modal (km/h) const modal = {a_pe:4, carro:45, offroad:25, onibus:35, caminhao:40, barco:30, aviao:600}; function tempoViagem(dA, dB, modo="carro"){ if(!rotas[dA] || !rotas[dA][dB]) return null; const km = rotas[dA][dB]; const v = modal[modo]||modal.carro; const horas = km / v; return {km, horas, s: horas*3600}; } function vizinhos(D){ return Object.keys(rotas[D]||{}); } // gravar no FS para edição futura writeJSON("distritos/rotas.json", rotas); return {distritos, rotas, modal, tempoViagem, vizinhos};
})(); /* ===== Painel Planetário ===== */
(function PlanetPanel(){ const box = document.createElement("div"); box.style.position="fixed"; box.style.right="10px"; box.style.bottom="10px"; box.style.zIndex="99992"; box.style.background="#0b141a"; box.style.color="#dff6ff"; box.style.border="1px solid #295063"; box.style.borderRadius="10px"; box.style.padding="10px 12px"; box.style.minWidth="280px"; box.style.maxHeight="32vh"; box.style.overflow="auto"; box.style.fontSize="12px"; box.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><strong>Estado Planetário</strong><button id="ppRefresh" style="margin-left:auto;padding:4px 8px;border-radius:8px;border:1px solid #2a5063;background:#12232c;color:#e7f6ff">atualizar</button></div><div id="ppBody" style="margin-top:6px;line-height:1.2"></div>`; document.body.appendChild(box); const body = box.querySelector("#ppBody"); function fmt(n){ return (Math.round(n*100)/100).toFixed(2); } function snapshot(){ const D = readJSON("distritos/index.json")||{}; const P = readJSON("personagens/index.json")||{}; const clima = readJSON("ambiente/clima.json")||{tempK:293.15, pressPa:101325, ruido_dB:45, lux:150}; const rows = []; Object.keys(D).forEach(k=>{ const pop = Object.values(P).filter(x=> (x && x.distrito===k)).length; rows.push(`${k} • bioma=${D[k].bioma||"?"} • fuso=${D[k].offset_hours||0}h • pop=${pop}`); }); const dt = new Date().toISOString(); return [ `tempo global: ${dt}`, `ambiente: T=${fmt(clima.tempK-273.15)} °C • P=${fmt(clima.pressPa)} Pa • ruído=${clima.ruido_dB} dB • lux=${clima.lux}`, rows.join("<br>") ].join("<br>"); } function render(){ body.innerHTML = snapshot(); } box.querySelector("#ppRefresh").onclick = render; setInterval(render, 1500); render();
})(); /* ===== Verificador de Sincronia ===== */
(function SyncGuard(){ const SYNC = {violacoes:0, log:[]}; function check(){ const P = readJSON("personagens/index.json")||{}; const index = {}; // personagemID -> {distrito, t} Object.keys(P).forEach(pid=>{ const path = `personagens/${pid}/posicao.json`; const p = readJSON(path) || {distrito: P[pid].distrito||"D1", t: Date.now()}; if(index[pid] && index[pid].distrito!==p.distrito){ SYNC.violacoes++; SYNC.log.push({pid, antes:index[pid], depois:p, msg:`${pid} em ${index[pid].distrito} e ${p.distrito}`}); // correção: escolher a mais recente e propagar const keep = (p.t>index[pid].t)? p : index[pid]; writeJSON(path, keep); }else{ index[pid] = p; } }); return SYNC; } setInterval(check, 1000); window.__SYNC__ = SYNC;
})(); /* ===== Loop de Propagação Planetária ===== */
(function PlanetPropagation(){ const BUS = window.__BUS__ = window.__BUS__ || []; function emit(evt){ BUS.push({...evt, t:Date.now()}); } function step(){ const evt = BUS.shift(); if(!evt) return; // Exemplo: um disparo em D1 ecoa (ruído/lux) em vizinhos com atenuação if(evt.tipo==="tiro"){ const d0 = evt.distrito; const viz = WORLD.vizinhos(d0); viz.forEach(v=>{ const ambPath = `ambiente/${v}.json`; const amb = readJSON(ambPath) || {}; amb.ruido_dB = Math.max((amb.ruido_dB||45), Math.max(45, (evt.dB||120) - 12)); // queda aproximada writeJSON(ambPath, amb); }); } // Exemplo: incêndio aumenta lux local e reduz oxigênio (futuro) } setInterval(step, 300); // expõe função global para outros sistemas dispararem eventos window.emitEventoGlobal = emit;
})(); /* ===== Inspector: planetário ===== */
(function inspPlanet(){ if(typeof INSPECTOR==="undefined") return; const _scan = INSPECTOR.scan; INSPECTOR.scan = function(){ const S = _scan(); const R = readJSON("distritos/rotas.json")||{}; const D = readJSON("distritos/index.json")||{}; Object.keys(D).forEach(k=>{ if(!R[k] || Object.keys(R[k]).length===0){ S.sugestoes++; S.last.push({tipo:"sugestao", msg:`Distrito ${k} sem rotas`}); } }); const P = readJSON("personagens/index.json")||{}; Object.keys(P).forEach(pid=>{ if(!D[P[pid].distrito||"D1"]){ S.erros++; S.last.push({tipo:"erro", msg:`${pid} em distrito inexistente`}); P[pid].distrito="D1"; } }); writeJSON("personagens/index.json", P); return S; };
})(); /* ===== ECO — IA do Som (WebAudio) ===== */
(function ECO_INIT(){ const AudioCtx = window.AudioContext || window.webkitAudioContext; const ctx = new AudioCtx(); const master = ctx.createGain(); master.gain.value = 0.85; master.connect(ctx.destination); // Mixer const CH = { ambiente: ctx.createGain(), sfx: ctx.createGain(), musica: ctx.createGain(), ui: ctx.createGain() }; CH.ambiente.gain.value = 0.6; CH.sfx.gain.value = 0.9; CH.musica.gain.value = 0.5; CH.ui.gain.value = 0.8; Object.values(CH).forEach(g => g.connect(master)); function ramp(g, v, t=0.2){ g.gain.cancelScheduledValues(ctx.currentTime); g.gain.linearRampToValueAtTime(v, ctx.currentTime + t); } // ---- Geradores base (sintéticos) ---- function whiteNoise(){ const buffer = ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate); const data = buffer.getChannelData(0); for(let i=0;i<data.length;i++){ data[i] = Math.random()*2-1; } return buffer; } const noiseBuf = whiteNoise(); function makeNoise(filterType="lowpass", freq=800){ const src = ctx.createBufferSource(); src.buffer = noiseBuf; src.loop = true; const biq = ctx.createBiquadFilter(); biq.type = filterType; biq.frequency.value = freq; src.connect(biq); return {src, biq}; } function tone(freq=220, type="sine"){ const o = ctx.createOscillator(); o.type = type; o.frequency.value = freq; const g = ctx.createGain(); g.gain.value = 0; o.connect(g); o.start(); return {o, g}; } // ---- Ambientes ---- const AMB = { rain: null, wind: null, city: null, night: null }; function ambient_rain(on=true, level=0.5){ if(on){ if(AMB.rain) return; const {src, biq} = makeNoise("lowpass", 2000); const g = ctx.createGain(); g.gain.value = 0; biq.connect(g); g.connect(CH.ambiente); src.start(); AMB.rain = {src, g}; ramp(g, level, 1.2); }else if(AMB.rain){ ramp(AMB.rain.g, 0, 0.8); setTimeout(()=>{ try{AMB.rain.src.stop();}catch{} AMB.rain=null; }, 900); } } function ambient_wind(on=true, level=0.3){ if(on){ if(AMB.wind) return; const {src, biq} = makeNoise("bandpass", 200); biq.Q.value = 0.7; const g = ctx.createGain(); g.gain.value = 0; biq.connect(g); g.connect(CH.ambiente); src.start(); AMB.wind = {src, g}; ramp(g, level, 1.0); }else if(AMB.wind){ ramp(AMB.wind.g, 0, 0.8); setTimeout(()=>{ try{AMB.wind.src.stop();}catch{} AMB.wind=null; }, 900); } } function ambient_city(on=true, level=0.25){ if(on){ if(AMB.city) return; const {src, biq} = makeNoise("bandpass", 600); biq.Q.value = 0.9; const g = ctx.createGain(); g.gain.value = 0; biq.connect(g); g.connect(CH.ambiente); src.start(); // buzinas esporádicas const int = setInterval(()=>{ const {o, g:gg} = tone(440 + Math.random()*80, "square"); gg.gain.value = 0.0; o.connect(gg); gg.connect(CH.ambiente); o.start(); gg.gain.linearRampToValueAtTime(0.08, ctx.currentTime+0.02); gg.gain.linearRampToValueAtTime(0, ctx.currentTime+0.25); setTimeout(()=>{ try{o.stop();}catch{} }, 350); }, 3500+Math.random()*3000); AMB.city = {src, g, int}; ramp(g, level, 1.0); }else if(AMB.city){ ramp(AMB.city.g, 0, 0.8); clearInterval(AMB.city.int); setTimeout(()=>{ try{AMB.city.src.stop();}catch{} AMB.city=null; }, 900); } } function ambient_night(on=true, level=0.18){ if(on){ if(AMB.night) return; const {src, biq} = makeNoise("bandpass", 4000); biq.Q.value = 5; const g = ctx.createGain(); g.gain.value = 0; biq.connect(g); g.connect(CH.ambiente); src.start(); AMB.night = {src, g}; ramp(g, level, 1.0); }else if(AMB.night){ ramp(AMB.night.g, 0, 0.8); setTimeout(()=>{ try{AMB.night.src.stop();}catch{} AMB.night=null; }, 900); } } // ---- SFX ---- function sfx_gun(type="tiro"){ // transiente agudo + ruído const {o, g} = tone(1800, "triangle"); g.connect(CH.sfx); g.gain.setValueAtTime(0.0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.8, ctx.currentTime+0.005); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.15); const n = makeNoise("highpass", 1000); const gn = ctx.createGain(); gn.gain.value = 0.6; n.biq.connect(gn); gn.connect(CH.sfx); n.src.start(); setTimeout(()=>{ try{n.src.stop();}catch{} }, 180); } function sfx_zombie(){ const base = 60 + Math.random()*20; const {o, g} = tone(base, "sawtooth"); const lfo = ctx.createOscillator(); lfo.frequency.value = 2 + Math.random()*2; const lg = ctx.createGain(); lg.gain.value = 15 + Math.random()*20; // depth lfo.connect(lg); lg.connect(o.frequency); g.connect(CH.sfx); g.gain.setValueAtTime(0.0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.4, ctx.currentTime+0.05); g.gain.linearRampToValueAtTime(0.0, ctx.currentTime+0.8); o.start(); lfo.start(); setTimeout(()=>{ try{o.stop(); lfo.stop();}catch{} }, 850); } function sfx_dog(){ const {o, g} = tone(500, "square"); g.connect(CH.sfx); g.gain.setValueAtTime(0.0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.5, ctx.currentTime+0.01); g.gain.linearRampToValueAtTime(0.0, ctx.currentTime+0.2); o.start(); setTimeout(()=>{ try{o.stop();}catch{} }, 220); } function sfx_car(skew=1){ const base = 60*skew; const {o, g} = tone(base, "sawtooth"); const n = makeNoise("lowpass", 500); const gn = ctx.createGain(); gn.gain.value = 0.2; n.biq.connect(gn); gn.connect(CH.sfx); g.connect(CH.sfx); g.gain.setValueAtTime(0.0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.3, ctx.currentTime+0.05); g.gain.linearRampToValueAtTime(0.0, ctx.currentTime+0.5); o.start(); n.src.start(); setTimeout(()=>{ try{o.stop(); n.src.stop();}catch{} }, 520); } // ---- Música dinâmica (camadas) ---- const MUS = { state:"menu", layers:[] }; function clearMusic(){ MUS.layers.forEach(x=>{ try{x.osc.stop();}catch{} }); MUS.layers = []; } function setMusic(state){ if(MUS.state===state) return; MUS.state = state; clearMusic(); if(state==="menu"){ // arpeggio simples const notes = [220, 277, 330, 440]; notes.forEach((f,i)=>{ const osc = ctx.createOscillator(); osc.type="sine"; osc.frequency.value = f; const g = ctx.createGain(); g.gain.value = 0.0; osc.connect(g); g.connect(CH.musica); osc.start(); const loop = setInterval(()=>{ g.gain.linearRampToValueAtTime(0.12, ctx.currentTime+0.01); g.gain.linearRampToValueAtTime(0.0, ctx.currentTime+0.35); }, 800 + i*60); MUS.layers.push({osc, g, loop}); }); }else if(state==="tenso"){ // drones + pulso const base = [110, 147, 196]; base.forEach((f,i)=>{ const osc = ctx.createOscillator(); osc.type="triangle"; osc.frequency.value = f; const g = ctx.createGain(); g.gain.value = 0.03; osc.connect(g); g.connect(CH.musica); osc.start(); MUS.layers.push({osc,g}); }); const kick = setInterval(()=>{ const {o, g} = tone(60, "sine"); g.connect(CH.musica); g.gain.value = 0.0; o.start(); g.gain.linearRampToValueAtTime(0.3, ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.22); setTimeout(()=>{ try{o.stop();}catch{} }, 240); }, 550); MUS.layers.push({osc:{stop:()=>{}}, loop:kick}); }else if(state==="combate"){ const base = [82, 110, 165]; base.forEach((f,i)=>{ const osc = ctx.createOscillator(); osc.type="sawtooth"; osc.frequency.value = f; const g = ctx.createGain(); g.gain.value = 0.05; osc.connect(g); g.connect(CH.musica); osc.start(); MUS.layers.push({osc,g}); }); const hat = setInterval(()=>{ const n = makeNoise("highpass", 6000); const g = ctx.createGain(); g.gain.value = 0.0; n.biq.connect(g); g.connect(CH.musica); n.src.start(); g.gain.linearRampToValueAtTime(0.12, ctx.currentTime+0.01); g.gain.linearRampToValueAtTime(0.0, ctx.currentTime+0.05); setTimeout(()=>{ try{n.src.stop();}catch{} }, 60); }, 180); MUS.layers.push({osc:{stop:()=>{}}, loop:hat}); } } // ---- Painel ECO ---- const pane = document.createElement("div"); pane.style.position="fixed"; pane.style.left="50%"; pane.style.transform="translateX(-50%)"; pane.style.bottom="10px"; pane.style.zIndex="99993"; pane.style.background="#0a0a12"; pane.style.color="#e8f0ff"; pane.style.border="1px solid #2d3a75"; pane.style.borderRadius="10px"; pane.style.padding="10px 12px"; pane.style.minWidth="320px"; pane.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><strong>ECO — Áudio</strong><button id="ecoStart" style="margin-left:auto;padding:4px 8px;border-radius:8px;border:1px solid #2a3b72;background:#12172c;color:#e7f6ff">iniciar áudio</button></div><div style="display:grid;grid-template-columns:1fr 1fr; gap:8px; margin-top:8px"><label>Ambiente <input id="volAmb" type="range" min="0" max="1" step="0.01" value="0.6"></label><label>SFX <input id="volSfx" type="range" min="0" max="1" step="0.01" value="0.9"></label><label>Música <input id="volMus" type="range" min="0" max="1" step="0.01" value="0.5"></label><label>UI <input id="volUI" type="range" min="0" max="1" step="0.01" value="0.8"></label></div>`; document.body.appendChild(pane); pane.querySelector("#ecoStart").onclick = ()=>{ ctx.resume(); // música de menu ao iniciar setMusic("menu"); }; pane.querySelector("#volAmb").oninput = (e)=> ramp(CH.ambiente, parseFloat(e.target.value), 0.1); pane.querySelector("#volSfx").oninput = (e)=> ramp(CH.sfx, parseFloat(e.target.value), 0.1); pane.querySelector("#volMus").oninput = (e)=> ramp(CH.musica, parseFloat(e.target.value), 0.1); pane.querySelector("#volUI").oninput = (e)=> ramp(CH.ui, parseFloat(e.target.value), 0.1); // ---- Integração com o mundo (BUS de eventos) ---- const BUS = window.__BUS__ = window.__BUS__ || []; setInterval(()=>{ const evt = BUS.shift(); if(!evt) return; if(evt.tipo==="tiro"){ sfx_gun(); setMusic("combate"); } if(evt.tipo==="zumbi_alerta"){ sfx_zombie(); setMusic("tenso"); } if(evt.tipo==="cachorro"){ sfx_dog(); } if(evt.tipo==="carro"){ sfx_car(evt.skew||1); } if(evt.tipo==="chuva_on"){ ambient_rain(true, 0.45); } if(evt.tipo==="chuva_off"){ ambient_rain(false); } if(evt.tipo==="vento_on"){ ambient_wind(true, 0.3); } if(evt.tipo==="vento_off"){ ambient_wind(false); } if(evt.tipo==="cidade_on"){ ambient_city(true, 0.25); } if(evt.tipo==="cidade_off"){ ambient_city(false); } if(evt.tipo==="noite_on"){ ambient_night(true, 0.18); } if(evt.tipo==="noite_off"){ ambient_night(false); } if(evt.tipo==="musica"){ setMusic(evt.modo||"menu"); } }, 120); // ---- Gatilhos contextuais automáticos ---- setInterval(()=>{ const amb = readJSON("ambiente/clima.json")||{}; const isNight = (new Date().getHours()<6 || new Date().getHours()>19); if(amb.chuva){ ambient_rain(true, 0.5); } else { ambient_rain(false); } if(amb.vento){ ambient_wind(true, 0.3); } else { ambient_wind(false); } if(amb.urbano){ ambient_city(true, 0.25); } else { ambient_city(false); } if(isNight){ ambient_night(true, 0.2); } else { ambient_night(false); } }, 1500); // ---- Expor ECO global (debug) ---- window.ECO = { setMusic, ambient_rain, ambient_wind, ambient_city, ambient_night, sfx_gun, sfx_zombie, sfx_dog, sfx_car, mixer: CH, ctx };
})(); /* ===== Hook: música de seleção de personagem ===== */
(function MenuMusicHook(){ function tick(){ try{ const st = window.__UI_STATE__ && window.__UI_STATE__.tela; if(st==="selecao_personagem" || st==="menu"){ if(window.ECO){ ECO.setMusic("menu"); } } }catch(e){} } setInterval(tick, 1000);
})(); /* ===== Painel de Teste ECO ===== */
(function EcoTest(){ const box = document.createElement("div"); box.style.position="fixed"; box.style.right="10px"; box.style.bottom="180px"; box.style.zIndex="99994"; box.style.background="#13100a"; box.style.color="#ffe9c9"; box.style.border="1px solid #6b4d1e"; box.style.borderRadius="10px"; box.style.padding="8px 10px"; box.style.minWidth="280px"; box.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><strong>ECO Test</strong><span style="opacity:.7">(debug)</span></div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px"><button data-evt="tiro">Tiro</button><button data-evt="zumbi_alerta">Zumbi</button><button data-evt="cachorro">Cachorro</button><button data-evt="carro">Carro</button><button data-evt="chuva_on">Chuva+</button><button data-evt="chuva_off">Chuva-</button><button data-evt="vento_on">Vento+</button><button data-evt="vento_off">Vento-</button><button data-evt="cidade_on">Cidade+</button><button data-evt="cidade_off">Cidade-</button><button data-evt="noite_on">Noite+</button><button data-evt="noite_off">Noite-</button><button data-evt="musica" data-modo="tenso">Música Tensa</button><button data-evt="musica" data-modo="combate">Combate</button><button data-evt="musica" data-modo="menu">Menu</button></div>`; document.body.appendChild(box); box.querySelectorAll("button").forEach(b=>{ b.onclick = ()=>{ const tipo = b.getAttribute("data-evt"); if(tipo==="musica"){ window.__BUS__ = window.__BUS__ || []; window.__BUS__.push({tipo:"musica", modo:b.getAttribute("data-modo")}); }else{ window.__BUS__ = window.__BUS__ || []; window.__BUS__.push({tipo}); } }; });
})(); // ----- BOOT UNIFICADO -----
window.addEventListener("load", ()=>{ try{ RAZAO.ensure(); ORDEM.impor(); UTERO.simular1000(); UTERO.loop(); FORCA.loop(); buildAvatarCache(); $("#panel").style.display=""; const active=getActive(); if(active){ $("#bootMsg").textContent="Save ativo detectado. Carregando sessão…"; loadSave(localStorage.getItem(STORE_ACTIVE)); $("#status").style.display="none"; } else { $("#bootMsg").textContent="Universo pronto. Escolha um avatar para entrar no Marco 0."; $("#avatar").style.display=""; $("#status").style.display=""; $("#play").style.display="none"; renderAvatars(""); } // botão continuar aparece se houver qualquer save if(Object.keys(getSaves()).length>0){ $("#btnContinue").style.display=""; $("#btnContinue").onclick=()=>{ loadSave(localStorage.getItem(STORE_ACTIVE)); $("#status").style.display="none"; }; } }catch(err){ $("#bootMsg").textContent="Erro no boot: "+err.message; }
});
</script><div class="small" style="padding:12px; text-align:center;">Build 2025-09-03T16:31:08.987890Z</div><div id="introOverlay"><h1>Corpo — Mundo Vivo</h1><p>O universo liga como um só corpo. As IAs <b>ALMA</b>, <b>RAZÃO</b>, <b>ORDEM</b>, <b>FORÇA</b>, <b>LEXIS</b>, <b>GUARDIÃO</b> e <b>ÚTERO</b> já estão ativas. Escolha sua linha de tempo, visualize a ficha do personagem e inicie.</p><div id="tlChooser"></div><button id="btnIniciar">Iniciar</button><small>Autosave a cada 2 escolhas • Salves paralelos preservados • Exportar/Importar em Configurações</small></div><div id="sheetModal"><div id="sheetCard"><button id="btnSheetClose">Fechar</button><h2>Ficha — <span id="sheetNome"></span><span id="sheetId" class="badge"></span></h2><div id="sheetAparencia"></div><div id="sheetAfinidade"></div><h3>Inventário</h3><table id="invTable"><thead><tr><th>Item</th><th>Qtd</th><th>Peso (kg)</th><th>Total</th></tr></thead><tbody></tbody></table><div id="invSummary"></div></div></div> /* ===== UI MANGÁ/ZOMBOID ===== */
<style id="mangaCSS">
:root{ --bg:#0b0b0e; --fg:#e8eaef; --soft:#b9c0cf; --accent:#7aa2ff; --panel:#121218; --ink:#0a0a0c; --ok:#46d17d; --warn:#f6c244; --bad:#ff5d5d;
}
html,body{ background:var(--bg); color:var(--fg); }
#uiRoot{ position:fixed; inset:0; display:grid; grid-template-columns: 260px 1fr 320px; grid-template-rows: 64px 1fr 120px; gap:8px; padding:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
}
#uiTopBar{ grid-column:1/4; background:var(--panel); border:1px solid #222231; border-radius:10px; display:flex; align-items:center; padding:8px 12px; gap:10px; }
#uiLeft{ background:var(--panel); border:1px solid #222231; border-radius:10px; padding:10px; overflow:auto; }
#uiCenter{ background:linear-gradient(#0c0c12, #0b0b0e); border:1px solid #222231; border-radius:10px; padding:0; display:grid; grid-template-rows: 62% 38%; overflow:hidden; }
#uiRight{ background:var(--panel); border:1px solid #222231; border-radius:10px; padding:10px; overflow:auto; }
#uiBottom{ grid-column:1/4; background:var(--panel); border:1px solid #222231; border-radius:10px; padding:10px; }
.badge{ border:1px solid #2b2b36; background:#13131b; padding:2px 6px; border-radius:6px; font-size:12px; color:var(--soft); }
.btn{ background:#12172c; color:#e7f0ff; border:1px solid #2a3a6d; border-radius:10px; padding:6px 10px; cursor:pointer; }
.btn:hover{ filter:brightness(1.08); }
.mangaPanel{ position:relative; margin:8px; border:2px solid #0c0c12; background:#0f0f15; border-radius:12px; overflow:hidden; box-shadow: inset 0 0 0 2px #0a0a0c; }
.mangaImg{ width:100%; height:100%; object-fit:cover; filter: grayscale(100%) contrast(1.2); }
.mangaCaption{ position:absolute; bottom:0; left:0; right:0; padding:10px 12px; background:linear-gradient(transparent, rgba(0,0,0,.75)); font-size:14px; }
.balloon{ display:inline-block; background:#f7f9ff; color:#13131b; padding:10px 12px; border-radius:14px; border:2px solid #0a0a0a; max-width:85%; }
#uiNarrative{ padding:10px; overflow:auto; }
.stat{ display:flex; justify-content:space-between; align-items:center; margin:6px 0; }
.bar{ height:6px; flex:1; margin-left:8px; background:#0e1322; border:1px solid #1c2744; border-radius:10px; overflow:hidden; }
.bar>i{ display:block; height:100%; background:linear-gradient(90deg,#3a74ff,#6affc0); width:50%; }
.invSlot{ border:1px dashed #2b2b36; border-radius:8px; padding:6px; margin:6px 0; min-height:24px; }
.invItem{ display:inline-block; padding:4px 6px; margin:2px; border-radius:8px; background:#162034; border:1px solid #2a3b72; color:#e7f6ff; cursor:grab; }
.choiceRow{ display:flex; gap:8px; flex-wrap:wrap; }
.choiceBtn{ background:#1d2339; border:1px solid #2b3a6a; color:#e7f0ff; padding:8px 12px; border-radius:10px; cursor:pointer; }
.choiceBtn:hover{ filter:brightness(1.08); }
kbd{ padding:2px 5px; background:#0f1421; border:1px solid #2a3a6d; border-radius:6px; font-size:12px; color:#a8c6ff;}
</style><div id="uiRoot"><div id="uiTopBar"><div class="badge">Corpo — v20 (Mangá/Zomboid)</div><div id="topInfo" class="badge">marco 0 • mundo vivo • planetário</div><div style="margin-left:auto; display:flex; gap:6px;"><button id="btnSkills" class="btn">Skills</button><button id="btnSalvar" class="btn">Salvar</button><button id="btnCarregar" class="btn">Carregar</button><button id="btnSettings" class="btn">Configurações</button><button id="btnNPC" class="btn">Personagens</button></div></div><div id="uiLeft"><div style="display:flex; gap:8px; align-items:center;"><div style="width:56px;height:56px;border-radius:50%;background:#0f0f15;border:1px solid #24243a;" id="portrait"></div><div><div id="nomeChar" style="font-weight:bold">—</div><div id="classeChar" class="badge">—</div></div></div><hr style="border:none;border-top:1px solid #24243a;margin:8px 0"><div class="stat"><span>Vida</span><div class="bar"><i id="barVida" style="width:75%"></i></div></div><div class="stat"><span>Fome</span><div class="bar"><i id="barFome" style="width:20%"></i></div></div><div class="stat"><span>Sede</span><div class="bar"><i id="barSede" style="width:35%"></i></div></div><div class="stat"><span>Cansaço</span><div class="bar"><i id="barCansaco" style="width:10%"></i></div></div><div class="stat"><span>Infecção</span><div class="bar"><i id="barInfeccao" style="width:0%"></i></div></div><div class="stat"><span>Carisma</span><div class="bar"><i id="barCarisma" style="width:50%"></i></div></div></div><div id="uiCenter"><div class="mangaPanel"><img id="sceneImg" class="mangaImg" alt="Painel da cena"><div class="mangaCaption"><span id="sceneCaption">—</span></div></div><div id="uiNarrative"></div></div><div id="uiRight"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:bold">Inventário</div><div class="badge" id="pesoBadge">0.0 / 25 kg</div></div><div id="invSlots"></div></div><div id="uiBottom"><div id="choiceBox" class="choiceRow"></div><div style="margin-top:8px; display:flex; gap:8px"><input id="inputCustom" placeholder="Personalize sua resposta..." style="flex:1;background:#0f1421;color:#e7f0ff;border:1px solid #2a3b72;border-radius:8px;padding:8px 10px"><button id="btnEnviar" class="btn">Enviar</button></div><div style="margin-top:6px; font-size:12px; color:#aab6d6">Dica: personalize com lógica e itens no seu raio. Atalho <kbd>Enter</kbd>.</div></div></div><div id="skillsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:99995; align-items:center; justify-content:center;"><div style="width:720px; max-width:95vw; background:#0f1118; border:1px solid #263056; border-radius:12px; padding:14px"><div style="display:flex; justify-content:space-between; align-items:center"><div style="font-weight:bold">Skills</div><button id="closeSkills" class="btn">Fechar</button></div><div id="skillsBody" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px"></div></div></div><div id="selectScreen" style="position:fixed; inset:0; background:linear-gradient(#0a0a12,#06060a); z-index:99996; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px;"><div style="font-size:22px; font-weight:bold; letter-spacing:1px;">Corpo — Seleção</div><div class="balloon" style="max-width:720px; font-size:16px;">ola meu nobre, oque tu é do Tigre?</div><div style="display:flex; gap:8px; width:720px; max-width:95vw;"><input id="selInput" placeholder="ex.: sou a mulher / sou o filho / Carol / criar personagem ..." style="flex:1;background:#0f1421;color:#e7f0ff;border:1px solid #2a3b72;border-radius:8px;padding:8px 10px"><button id="selBtn" class="btn">Confirmar</button></div><div style="display:flex; gap:8px; flex-wrap:wrap; width:720px; max-width:95vw; justify-content:center; margin-top:6px"><button class="btn quickSel" data-q="Tigre">Tigre</button><button class="btn quickSel" data-q="Carol">Carol</button><button class="btn quickSel" data-q="sou o filho">Filho (aleatório)</button><button class="btn quickSel" data-q="sou a filha">Filha</button><button class="btn quickSel" data-q="criar personagem">Criar Personagem</button></div><div style="margin-top:14px; font-size:12px; color:#9fb3ff">Biologia: homem/mulher; Cultura social inclusa (LGBTQIA+, pessoas com deficiência). Regras do Cérebro aplicadas.</div></div><script>
(function(){ window.__UI_STATE__ = window.__UI_STATE__ || { tela:"menu" }; const BUS = window.__BUS__ = window.__BUS__ || []; // Helpers base do FS (supõe já existir no motor; fallback simples) window.readJSON = window.readJSON || (path=>{ try{ return JSON.parse(localStorage.getItem(path)||"null"); }catch(e){ return null; } }); window.writeJSON = window.writeJSON || ((path,obj)=>{ localStorage.setItem(path, JSON.stringify(obj)); }); // ===== Dados essenciais: fallback mínimo de personagens com família do Tigre ===== function ensureBase(){ const P = readJSON("personagens/index.json") || {}; if(!P["TIGRE"]){ P["TIGRE"] = { id:"TIGRE", nome:"Tigre", sexo:"M", relacoes:{conjuge:"CAROL", filhos:["FILHO_A","FILHO_B","FILHA"]}, distrito:"D1", classe:"Sobrevivente" }; } if(!P["CAROL"]){ P["CAROL"] = { id:"CAROL", nome:"Carol", sexo:"F", relacoes:{conjuge:"TIGRE", filhos:["FILHO_A","FILHO_B","FILHA"]}, distrito:"D1", classe:"Sobrevivente" }; } if(!P["FILHO_A"]){ P["FILHO_A"] = { id:"FILHO_A", nome:"Filho A", sexo:"M", relacoes:{pai:"TIGRE", mae:"CAROL"}, distrito:"D1", classe:"Dependente" }; } if(!P["FILHO_B"]){ P["FILHO_B"] = { id:"FILHO_B", nome:"Filho B", sexo:"M", relacoes:{pai:"TIGRE", mae:"CAROL"}, distrito:"D1", classe:"Dependente" }; } if(!P["FILHA"]){ P["FILHA"] = { id:"FILHA", nome:"Filha", sexo:"F", relacoes:{pai:"TIGRE", mae:"CAROL"}, distrito:"D1", classe:"Dependente" }; } writeJSON("personagens/index.json", P); // skills defaults por personagem ["TIGRE","CAROL","FILHO_A","FILHO_B","FILHA"].forEach(pid=>{ const path = `personagens/${pid}/skills.json`; if(!readJSON(path)){ writeJSON(path, { Combate:{ ArmasFogo:{lvl:1,xp:0}, Brancas:{lvl:1,xp:0}, Defesa:{lvl:1,xp:0} }, Sobrevivencia:{ Furtividade:{lvl:1,xp:0}, Construcao:{lvl:1,xp:0}, Agricultura:{lvl:1,xp:0} }, Sociais:{ Carisma:{lvl:1,xp:0}, Lideranca:{lvl:1,xp:0}, Intimidacao:{lvl:1,xp:0} }, Tecnicas:{ Mecanica:{lvl:1,xp:0}, Medicina:{lvl:1,xp:0}, Eletronica:{lvl:1,xp:0}, Costura:{lvl:1,xp:0} } }); } }); // inventário básico ["TIGRE","CAROL"].forEach(pid=>{ const invp = `personagens/${pid}/inventario.json`; if(!readJSON(invp)){ writeJSON(invp, {capKg:25, itens:[ {id:"agua500", nome:"Garrafa de água 500ml", m:0.5}, {id:"barra_energetica", nome:"Barra energética", m:0.08} ]}); } }); } ensureBase(); // ===== UI refs const sceneImg = document.getElementById("sceneImg"); const sceneCaption = document.getElementById("sceneCaption"); const narrative = document.getElementById("uiNarrative"); const choiceBox = document.getElementById("choiceBox"); const inputCustom = document.getElementById("inputCustom"); const btnEnviar = document.getElementById("btnEnviar"); const invSlots = document.getElementById("invSlots"); const nomeChar = document.getElementById("nomeChar"); const classeChar = document.getElementById("classeChar"); const portrait = document.getElementById("portrait"); const selectScreen = document.getElementById("selectScreen"); // ===== Estado do jogo const GAME = window.__GAME__ = window.__GAME__ || { ativo:null, turno:0 }; // ===== Skills function renderSkills(pid){ const modal = document.getElementById("skillsModal"); const body = document.getElementById("skillsBody"); body.innerHTML = ""; const data = readJSON(`personagens/${pid}/skills.json`)||{}; Object.keys(data).forEach(grupo=>{ const gdiv = document.createElement("div"); gdiv.style.border="1px solid #27324e"; gdiv.style.borderRadius="8px"; gdiv.style.padding="8px"; const title = document.createElement("div"); title.textContent = grupo; title.style.fontWeight="bold"; gdiv.appendChild(title); Object.keys(data[grupo]).forEach(sk=>{ const row = document.createElement("div"); row.style.display="flex"; row.style.alignItems="center"; row.style.justifyContent="space-between"; row.style.marginTop="6px"; const left = document.createElement("span"); left.textContent = `${sk}`; const right = document.createElement("span"); right.className="badge"; const s = data[grupo][sk]; right.textContent = `Lv ${s.lvl} — XP ${s.xp}`; row.appendChild(left); row.appendChild(right); gdiv.appendChild(row); }); body.appendChild(gdiv); }); modal.style.display="flex"; } function gainXP(pid, grupo, sk, q){ const data = readJSON(`personagens/${pid}/skills.json`)||{}; if(!data[grupo] || !data[grupo][sk]) return; data[grupo][sk].xp += q; while(data[grupo][sk].xp >= 100){ data[grupo][sk].xp -= 100; data[grupo][sk].lvl += 1; } writeJSON(`personagens/${pid}/skills.json`, data); } function hookSkillsUI(pid){ document.getElementById("btnSkills").onclick = ()=> renderSkills(pid); document.getElementById("closeSkills").onclick = ()=> (document.getElementById("skillsModal").style.display="none"); } // ===== Inventário básico (lista; pode evoluir para drag&drop) function renderInv(pid){ const inv = readJSON(`personagens/${pid}/inventario.json`)||{capKg:25,itens:[]}; invSlots.innerHTML = ""; let peso = 0; inv.itens.forEach(it=>{ peso += (it.m||0); const el = document.createElement("div"); el.className="invItem"; el.textContent = `${it.nome} (${it.m||0} kg)`; invSlots.appendChild(el); }); document.getElementById("pesoBadge").textContent = `${peso.toFixed(1)} / ${inv.capKg} kg`; } // ===== Narrativa (painéis mangá) function say(html){ const b = document.createElement("div"); b.className="balloon"; b.innerHTML = html; const wrap = document.createElement("div"); wrap.style.margin="8px 10px"; wrap.appendChild(b); narrative.appendChild(wrap); narrative.scrollTop = narrative.scrollHeight; } function setScene(img, caption){ sceneImg.src = img || ""; sceneCaption.textContent = caption || ""; } // ===== Escolhas + Personalizado function setChoices(opts){ choiceBox.innerHTML = ""; opts.forEach(o=>{ const b = document.createElement("button"); b.className="choiceBtn"; b.textContent = o.txt; b.onclick = ()=> o.on(); choiceBox.appendChild(b); }); } function handleCustom(){ const val = inputCustom.value.trim(); if(!val) return; inputCustom.value = ""; // aqui validamos pelo raio e inventário (simplificado) say(`<b>Você:</b> ${val}`); // exemplo: ganhar XP em Social-Carisma por responder if(GAME.ativo){ gainXP(GAME.ativo, "Sociais", "Carisma", 5); } // gatilho sonoro leve BUS.push({tipo:"cidade_on"}); } btnEnviar.onclick = handleCustom; inputCustom.addEventListener("keydown", (e)=>{ if(e.key==="Enter") handleCustom(); }); // ===== Seleção: interpretação "o que tu é do Tigre" function normalize(s){ return (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""); } function pickChild(which){ const options = ["FILHO_A","FILHO_B","FILHA"]; if(which==="filho"){ return options[Math.floor(Math.random()*2)]; } if(which==="filha"){ return "FILHA"; } return options[Math.floor(Math.random()*options.length)]; } function resolveSelection(text){ const t = normalize(text); const P = readJSON("personagens/index.json")||{}; // atalhos diretos por nome for(const pid of Object.keys(P)){ if(normalize(P[pid].nome)===t){ return pid; } } if(t.includes("sou a mulher") || t.includes("sou a esposa") || t==="carol"){ return "CAROL"; } if(t.includes("sou o marido") || t==="tigre"){ return "TIGRE"; } if(t.includes("sou o filho") || t.includes("sou filho")){ return pickChild("filho"); } if(t.includes("sou a filha") || t.includes("sou filha")){ return pickChild("filha"); } if(t.includes("criar personagem") || t.startsWith("criar")){ // cria personagem novo respeitando regras; se disser genero, aplica const sexo = t.includes("mulher")?"F": t.includes("homem")?"M": (Math.random()>0.5?"M":"F"); const id = "PERS_"+Math.random().toString(36).slice(2,8).toUpperCase(); const nome = (sexo==="F"?"Nômade F":"Nômade M")+" "+id.slice(-2); P[id] = { id, nome, sexo, relacoes:{}, distrito:"D1", classe:"Nômade" }; writeJSON("personagens/index.json", P); // skills e inventário base writeJSON(`personagens/${id}/skills.json`, { Combate:{ ArmasFogo:{lvl:1,xp:0}, Brancas:{lvl:1,xp:0}, Defesa:{lvl:1,xp:0} }, Sobrevivencia:{ Furtividade:{lvl:1,xp:0}, Construcao:{lvl:1,xp:0}, Agricultura:{lvl:1,xp:0} }, Sociais:{ Carisma:{lvl:1,xp:0}, Lideranca:{lvl:1,xp:0}, Intimidacao:{lvl:1,xp:0} }, Tecnicas:{ Mecanica:{lvl:1,xp:0}, Medicina:{lvl:1,xp:0}, Eletronica:{lvl:1,xp:0}, Costura:{lvl:1,xp:0} } }); writeJSON(`personagens/${id}/inventario.json`, {capKg:22, itens:[{id:"agua500",nome:"Garrafa de água 500ml",m:0.5}]}); return id; } // se escreveu "sou X do tigre" (filho/filha/mulher/marido) já coberto; tenta nome de outro personagem // Se não conseguiu, pergunta novamente mantendo tela return null; } function startGameAs(pid){ const P = readJSON("personagens/index.json")||{}; const ch = P[pid]; if(!ch){ return; } window.__UI_STATE__.tela = "jogo"; selectScreen.style.display = "none"; // retrato e labels nomeChar.textContent = ch.nome; classeChar.textContent = ch.classe || "—"; portrait.style.background = "#11121a url('') center/cover no-repeat"; // cena inicial (mangá): usando gerador interno (placeholder) setScene("", `Início de ${ch.nome} no distrito ${ch.distrito}`); say(`<b>${ch.nome}:</b> respirando fundo, observa os arredores. O mundo pulsa como um mangá vivo.`); setChoices([ {txt:"Observar em volta", on:()=>{ say("Você analisa o cenário. Sons distantes ecoam."); BUS.push({tipo:"cidade_on"}); gainXP(pid,"Sobrevivencia","Furtividade",5); }}, {txt:"Checar inventário", on:()=>{ renderInv(pid); say("Você confere o inventário e o peso total."); }}, {txt:"Seguir adiante", on:()=>{ say("Você segue pela rua com cautela."); BUS.push({tipo:"vento_on"}); }}, {txt:"Personalize sua resposta", on:()=>{ inputCustom.focus(); }} ]); renderInv(pid); hookSkillsUI(pid); // Música: se menu estava tocando, trocamos para exploratório (tenso leve) if(window.ECO){ ECO.setMusic("tenso"); } } // ===== Bind seleção document.querySelectorAll(".quickSel").forEach(b=>{ b.onclick = ()=>{ const v = b.getAttribute("data-q"); document.getElementById("selInput").value = v; }; }); document.getElementById("selBtn").onclick = ()=>{ const v = document.getElementById("selInput").value.trim(); const pid = resolveSelection(v); if(pid){ startGameAs(pid); } else { alert("Não entendi. Tente: 'sou a mulher', 'sou o filho', 'Carol', 'Tigre' ou 'criar personagem'."); } }; // estado de tela: seleção (ativa música de menu via ECO Hook já existente) window.__UI_STATE__.tela = "selecao_personagem"; // Prepara imagem de cena padrão (placeholder) setScene("", "Painel inicial — aguarde eventos."); // Botões salvar/carregar (integram com o sistema já existente do motor via localStorage simples) document.getElementById("btnSalvar").onclick = ()=>{ const snap = { ativo: GAME.ativo, turno: GAME.turno, P: readJSON("personagens/index.json"), }; localStorage.setItem("SAVE_GLOBAL", JSON.stringify(snap)); alert("Save global atualizado."); }; document.getElementById("btnCarregar").onclick = ()=>{ const s = localStorage.getItem("SAVE_GLOBAL"); if(!s){ alert("Nenhum save global."); return; } const snap = JSON.parse(s); writeJSON("personagens/index.json", snap.P); GAME.ativo = snap.ativo; GAME.turno = snap.turno||0; alert("Save global carregado."); }; })(); </script><style id="v21CSS">
/* NSFW/18+ */
#ageGate{ position:fixed; inset:0; background:rgba(0,0,0,.86); z-index:100000; display:flex; align-items:center; justify-content:center; }
#ageGate>div{ width:560px; max-width:95vw; background:#0f1118; border:1px solid #2a3150; border-radius:12px; padding:16px; text-align:center; }
.nsfwBlur{ filter: blur(14px) grayscale(100%); }
#settingsPane{ position:fixed; right:8px; top:74px; width:320px; max-width:92vw; background:#0f1118; border:1px solid #2a3150; border-radius:12px; padding:10px; z-index:99990; display:none; }
.settingRow{ display:flex; justify-content:space-between; align-items:center; margin:8px 0; }
.toggle{ appearance:none; width:42px; height:24px; background:#20253a; border:1px solid #33406e; border-radius:20px; position:relative; outline:none; cursor:pointer; }
.toggle:checked{ background:#2b5bd8; }
.toggle::after{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:50%; background:#e9f0ff; transition:transform .18s; }
.toggle:checked::after{ transform:translateX(18px); }
.badge18{ background:#2b1326; color:#ff9ac8; border:1px solid #5a1f41; padding:2px 6px; border-radius:8px; }
</style><div id="settingsPane"><div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-weight:bold">Configurações</div><button id="btnCloseSettings" class="btn">Fechar</button></div><div class="settingRow"><span>+18 habilitado</span><input id="set18" type="checkbox" class="toggle"></div><div class="settingRow"><span>Desbloquear imagens NSFW</span><input id="setNSFW" type="checkbox" class="toggle"></div><div style="font-size:12px;color:#a7b2d6">Cenas adultas seguem regras: consentimento explícito, sem menores, sem violência sexual. Conteúdo explícito é filtrado por padrão.</div></div><div id="ageGate" style="display:none;"><div><div style="font-size:20px; font-weight:bold; margin-bottom:6px;">Conteúdo +18</div><div style="color:#b8c2ea; font-size:14px; margin-bottom:10px;"> Este mundo pode conter sexo, nudez, linguagem imprópria e drogas. Ao prosseguir você confirma ter 18+ e concorda com as regras de consentimento e segurança. </div><div style="display:flex; gap:8px; justify-content:center;"><button id="ageYes" class="btn">Tenho 18+</button><button id="ageNo" class="btn">Sair</button></div><div style="margin-top:10px;"><span class="badge18">+18</span></div></div></div><script>
(function(){ // === IMAGE CACHE (IndexedDB + WebP) === const DB_NAME = "CORPO_DB"; const DB_VER = 1; let db = null; function openDB(){ return new Promise((res,rej)=>{ const r = indexedDB.open(DB_NAME, DB_VER); r.onupgradeneeded = (e)=>{ const d = e.target.result; if(!d.objectStoreNames.contains("images")) d.createObjectStore("images"); if(!d.objectStoreNames.contains("json")) d.createObjectStore("json"); }; r.onsuccess = ()=>{ db = r.result; res(); }; r.onerror = ()=> rej(r.error); });} async function cacheGet(store, key){ if(!db) await openDB(); return await new Promise((res,rej)=>{ const tx = db.transaction(store, "readonly"); const st = tx.objectStore(store); const req = st.get(key); req.onsuccess = ()=> res(req.result||null); req.onerror = ()=> rej(req.error); }); } async function cacheSet(store, key, val){ if(!db) await openDB(); return await new Promise((res,rej)=>{ const tx = db.transaction(store, "readwrite"); const st = tx.objectStore(store); const req = st.put(val, key); req.onsuccess = ()=> res(true); req.onerror = ()=> rej(req.error); }); } async function toWebPBlob(imgEl, quality=0.72, maxW=1280, maxH=960){ const canvas = document.createElement("canvas"); let w = imgEl.naturalWidth || imgEl.width; let h = imgEl.naturalHeight || imgEl.height; const r = Math.min(maxW/w, maxH/h, 1.0); w = Math.floor(w*r); h = Math.floor(h*r); canvas.width = w; canvas.height = h; const ctx = canvas.getContext("2d"); ctx.drawImage(imgEl,0,0,w,h); const dataURL = canvas.toDataURL("image/webp", quality); const bin = atob(dataURL.split(",")[1]); const arr = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return new Blob([arr], {type:"image/webp"}); } async function getOrCacheImage(key, srcOrGenerator){ // srcOrGenerator: string URL/base64 ou função async que retorna dataURL const cached = await cacheGet("images", key); if(cached){ return URL.createObjectURL(cached); } // gerar / baixar let dataURL = null; if(typeof srcOrGenerator === "string"){ dataURL = srcOrGenerator; }else{ dataURL = await srcOrGenerator(); } // cria img temporária p/ comprimir const img = new Image(); img.crossOrigin = "anonymous"; const done = new Promise((res)=>{ img.onload = ()=> res(); }); img.src = dataURL; await done; const blob = await toWebPBlob(img, 0.76, 1400, 1000); await cacheSet("images", key, blob); return URL.createObjectURL(blob); } // Expor para motor/Alma window.IMG_CACHE = { getOrCacheImage }; // === SETTINGS / +18 / NSFW === const settingsPane = document.getElementById("settingsPane"); const btnSettings = document.getElementById("btnSettings"); const btnCloseSettings = document.getElementById("btnCloseSettings"); const set18 = document.getElementById("set18"); const setNSFW = document.getElementById("setNSFW"); const ageGate = document.getElementById("ageGate"); const sceneImg = document.getElementById("sceneImg"); function loadSettings(){ const s = JSON.parse(localStorage.getItem("SETTINGS")||"{}"); set18.checked = !!s.age18; setNSFW.checked = !!s.nsfw; return s; } function saveSettings(s){ localStorage.setItem("SETTINGS", JSON.stringify(s)); } btnSettings.onclick = ()=>{ settingsPane.style.display="block"; }; btnCloseSettings.onclick = ()=>{ settingsPane.style.display="none"; }; set18.onchange = ()=>{ const s = loadSettings(); s.age18 = set18.checked; saveSettings(s); applyNSFW(); }; setNSFW.onchange = ()=>{ const s = loadSettings(); s.nsfw = setNSFW.checked; saveSettings(s); applyNSFW(); }; function applyNSFW(){ const s = loadSettings(); if(!s.age18){ ageGate.style.display = "flex"; sceneImg.classList.add("nsfwBlur"); } else { ageGate.style.display = "none"; } // NSFW visual só libera se age18 true e nsfw true if(s.age18 && s.nsfw){ sceneImg.classList.remove("nsfwBlur"); } else { sceneImg.classList.add("nsfwBlur"); } } // Age gate controls document.getElementById("ageYes").onclick = ()=>{ const s = loadSettings(); s.age18 = true; saveSettings(s); applyNSFW(); }; document.getElementById("ageNo").onclick = ()=>{ alert("Fechando por requisito etário."); window.location.href="about:blank"; }; // Na primeira carga, aplicar applyNSFW(); // === SUBSTANCES (buffs/debuffs) === // Simplificado com efeitos genéricos; sem instruções de fabricação. const SUBS = { "cannabis": { dur: 30*60, buffs:{Calma:+0.2}, debuffs:{Reacao:-0.1}, risco:"baixo" }, "alcool": { dur: 20*60, buffs:{Coragem:+0.1}, debuffs:{Coordenacao:-0.2, Percepcao:-0.1}, risco:"medio" }, "energetico": { dur: 15*60, buffs:{Vigor:+0.2}, debuffs:{Ansiedade:+0.1}, risco:"baixo" }, "analgesico": { dur: 25*60, buffs:{Dor:-0.3}, debuffs:{Atencao:-0.1}, risco:"medio" } }; window.SUBS = SUBS; const STAT = window.STAT = window.STAT || { Calma:0, Reacao:0, Coragem:0, Coordenacao:0, Percepcao:0, Vigor:0, Ansiedade:0, Dor:0, Atencao:0 }; let activeSubs = []; function useSubstance(id){ const s = SUBS[id]; if(!s) return; const now = Date.now(); activeSubs.push({id, until: now + s.dur*1000}); recalcStats(); } function recalcStats(){ // reset for(const k in STAT){ STAT[k]=0; } const now = Date.now(); activeSubs = activeSubs.filter(x=> x.until>now); activeSubs.forEach(x=>{ const s = SUBS[x.id]; if(s.buffs){ for(const k in s.buffs){ STAT[k]=(STAT[k]||0)+s.buffs[k]; } } if(s.debuffs){ for(const k in s.debuffs){ STAT[k]=(STAT[k]||0)+s.debuffs[k]; } } }); } window.useSubstance = useSubstance; // Exemplo: integrar com ECO para feedback sonoro/sensorial (leve click) if(window.ECO){ window.useSubstance = (id)=>{ const s = SUBS[id]; if(!s) return; const now = Date.now(); activeSubs.push({id, until: now + s.dur*1000}); ECO.click && ECO.click(); recalcStats(); }; } // === SCENE IMAGE via cache (placeholder gerado) === const origSetScene = window.setScene; window.setScene = async function(img, caption){ try{ // Se vier uma key lógica (ex.: "TIGRE_INICIO"), gera/obtém e cacheia if(img && !img.startsWith("data:") && !img.startsWith("blob:") && !img.startsWith("http")){ // gerador simples: painel cinza com texto (placeholder); Alma pode substituir por dataURL real const dataURL = await (async () => { const canvas = document.createElement("canvas"); canvas.width=1100; canvas.height=620; const ctx = canvas.getContext("2d"); ctx.fillStyle="#0c0c12"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="#ffffff"; ctx.font="28px serif"; ctx.fillText(img.replace(/_/g," "), 40, 60); ctx.font="18px serif"; ctx.fillText("Mangá — placeholder (Alma substituirá)", 40, 96); return canvas.toDataURL("image/png"); })(); const url = await IMG_CACHE.getOrCacheImage(img, dataURL); document.getElementById("sceneImg").src = url; }else if(img){ const url = await IMG_CACHE.getOrCacheImage("EXT_"+img, img); document.getElementById("sceneImg").src = url; } }catch(e){ document.getElementById("sceneImg").src = ""; } document.getElementById("sceneCaption").textContent = caption||""; }; // Expor um utilitário para a Alma empurrar imagens novas do mundo e salvar no cache window.pushWorldImage = async function(key, dataURL){ const url = await IMG_CACHE.getOrCacheImage(key, dataURL); return url; }; // === BOTÃO RÁPIDO: abrir settings via teclado (S) === document.addEventListener("keydown", (e)=>{ if(e.key.toLowerCase()==="s" && (e.ctrlKey||e.metaKey)){ e.preventDefault(); settingsPane.style.display="block"; } }); // marca que v21 carregou console.log("v21 worldpack: cache de imagens + NSFW + substâncias ativo.");
})();
</script></body><script>
(function(){ // ===== Audio Unlock ===== let audioUnlocked = false; function unlockAudio(){ try{ const ctx = window.__audioCtx || (window.__audioCtx = (window.AudioContext? new AudioContext(): (window.webkitAudioContext? new webkitAudioContext(): null))); if(ctx && ctx.state === 'suspended'){ ctx.resume(); } audioUnlocked = true; window.removeEventListener('touchstart', unlockAudio); window.removeEventListener('pointerdown', unlockAudio); window.removeEventListener('keydown', unlockAudio); }catch(e){/* noop */} } window.addEventListener('touchstart', unlockAudio, {passive:true}); window.addEventListener('pointerdown', unlockAudio, {passive:true}); window.addEventListener('keydown', unlockAudio); // ===== Auto-Start / Fallback ===== window.__SCENE_RENDERED__ = false; // caso o motor marque quando renderiza const markRendered = ()=>{ window.__SCENE_RENDERED__ = true; }; if(!window.NARRATIVE){ window.NARRATIVE = {}; } window.NARRATIVE.__markRendered = markRendered; function tryStart(){ // 1) Preferir APIs do motor if(typeof window.boot === 'function'){ try{ window.boot(); return true; }catch(e){} } if(typeof window.startGame === 'function'){ try{ window.startGame(); return true; }catch(e){} } if(typeof window.MOTOR?.start === 'function'){ try{ window.MOTOR.start(); return true; }catch(e){} } // 2) Fallback: clicar botão "Iniciar" const btns = Array.from(document.querySelectorAll('button, a, [role="button"]')); const b = btns.find(x => /iniciar|começar|start/i.test(x.textContent||"")); if(b){ b.click(); return true; } // 3) Último recurso: emitir evento window.dispatchEvent(new CustomEvent('START_REQUEST')); return false; } // tenta iniciar após DOM pronto window.addEventListener('DOMContentLoaded', ()=>{ setTimeout(()=>{ const ok = tryStart(); // watchdog: se em 2s não renderizou, tenta de novo setTimeout(()=>{ if(!window.__SCENE_RENDERED__){ tryStart(); } }, 2000); }, 50); }); // ===== setFPS exposto (liga com loop v24) ===== (function(){ // intercepta o loop se ele expuser variáveis globais const g = window; let _hz = 30; g.setFPS = function(hz){ _hz = Math.max(5, Math.min(120, hz|0)); // Ajuste por variável global se existir if(g.__SET_FPS_TARGET__) g.__SET_FPS_TARGET__(_hz); // badge const p = document.getElementById('fpsPanel'); if(p){ p.textContent = p.textContent.replace(/FPS:\s*\d+/, 'FPS: '+_hz); } if(g.trackEvent) g.trackEvent('debug:setFPS',{hz:_hz}); }; // injeta ponte para o loop v24 const hook = ()=>{ if(!g.__SET_FPS_TARGET__ && g.__LOOP_EXPORTS__){ g.__SET_FPS_TARGET__ = g.__LOOP_EXPORTS__.setTargetFPS; } }; setInterval(hook, 500); // atalho de teclado: F alterna 30/60 window.addEventListener('keydown', (e)=>{ if((e.key||'').toLowerCase()==='f'){ g.setFPS(_hz===30?60:30); } }); })(); console.log("v25: auto-start + fallback + audio unlock + setFPS");
})();
</script><script> /* DEV PLAYBOOK v1 — injete após carregar o motor */
window.DEV = window.DEV || {};
window.DEV.playbook = { "version": "1.0", "generated_at": "2025-09-03 18:19:06", "pipeline": { "stages": [ { "id": "plan", "nome": "Planejamento", "saidas": [ "Visão", "público-alvo", "escopo", "risco" ] }, { "id": "preprod", "nome": "Pré-produção", "saidas": [ "GDD", "protótipo", "pilha tecnológica", "cronograma" ] }, { "id": "prod", "nome": "Produção", "saidas": [ "conteúdo", "features", "arte", "áudio", "níveis" ] }, { "id": "test", "nome": "Testes contínuos", "saidas": [ "QA", "automação", "playtests", "telemetria" ] }, { "id": "prelaunch", "nome": "Pré-lançamento", "saidas": [ "beta", "otimização", "loja", "marketing" ] }, { "id": "launch", "nome": "Lançamento", "saidas": [ "build final", "backend/loja", "monitoramento" ] }, { "id": "liveops", "nome": "Pós-lançamento / Live Ops", "saidas": [ "patches", "eventos", "balance" ] } ], "gdd_secoes": [ "Visão & Fantasy", "Loop central", "Mecânicas", "Personagens & Progressão", "Mundo & Economia", "UI/UX", "Conteúdo & Missões", "Áudio", "Monetização (se houver)", "Tec/Build/Plataformas" ] }, "equipe": { "nucleos": [ { "nome": "Direção", "cargos": [ "Diretor criativo", "Produtor/PM" ] }, { "nome": "Design", "cargos": [ "Game designer", "Level designer", "Narrative designer" ] }, { "nome": "Engenharia", "cargos": [ "Gameplay", "Ferramentas", "Build/DevOps" ] }, { "nome": "Arte", "cargos": [ "2D/3D", "Tech art", "Animação", "UI" ] }, { "nome": "Áudio", "cargos": [ "Sound design", "Music", "Middleware (FMOD/Wwise)" ] }, { "nome": "QA/UX", "cargos": [ "QA lead", "Testers", "User Research" ] }, { "nome": "Dados", "cargos": [ "Telemetria", "Analytics/KPIs" ] } ], "mapeamento_para_Corpo": [ { "papel": "Produtor/PM", "ia": "ORDEM", "obs": "faz cumprir regras, cronograma e DoD" }, { "papel": "Lead Engenharia", "ia": "RAZAO", "obs": "organiza entradas e pastas do motor" }, { "papel": "Engine runtime", "ia": "ANIMA (ALMA)", "obs": "orquestra info em tempo real" }, { "papel": "DevOps/Observabilidade", "ia": "GUARDIAO", "obs": "linhas do tempo, saves" }, { "papel": "Qualidade/Anticorpos", "ia": "UTERO", "obs": "gera IAs pequenas para correções" }, { "papel": "Infra/Health-check", "ia": "FORCA", "obs": "varredura de integridade contínua" } ] }, "arquitetura": { "loop": { "tipo": "timestep fixo", "hz": [ 30, 60 ], "render": "desacoplado" }, "ecs": { "entidades": "IDs", "componentes": "dados puros", "sistemas": "regras sobre componentes" }, "assets_pipeline": [ "fonte", "processamento", "import", "cache", "runtime" ], "audio": { "middleware": [ "FMOD", "Wwise" ], "padrao_eventos": true } }, "processos": { "git_branching": "GitFlow adaptado: main, develop, feature/*, hotfix/*, release/*", "kpis": [ "DAU", "MAU", "Retenção D1/D7/D30", "Churn", "ARPDAU", "LTV", "Engajamento", "Sessão média" ], "def_of_done": [ "build passa", "tests ok", "perf ok", "sem regressões", "localização ok" ] }
}; /* Integrações rápidas */
window.DEV.toggleFPS = function(hz){ if(window.setFPS) window.setFPS(hz);
};
window.DEV.enableAnalytics = function(){ if(!window.ANALYTICS){ window.ANALYTICS = {enabled:true, events:[]}; } const track = (name, data)=>{ window.ANALYTICS.events.push({t:Date.now(), name, data}); }; window.trackEvent = track;
}; </script><script>
(function(){ // ===== Game Loop (30 FPS) ===== const FPS_TARGET = 30; const FRAME_MS = 1000 / FPS_TARGET; let last = performance.now(), acc = 0, frames=0, lastSec = performance.now(), fps=0; const fpsPanel = document.getElementById("fpsPanel"); // relógio diégese (sincroniza com Guardião/linha do tempo se existir) let worldTime = new Date(); // inicia no horário local; motor pode sobrescrever function step(dt){ // 1) IA internas (alma, razão, guardião, ordem, útero, força) se expostas if(window.ANIMA && typeof window.ANIMA.tick === "function") window.ANIMA.tick(dt); if(window.RAZAO && typeof window.RAZAO.tick === "function") window.RAZAO.tick(dt); if(window.GUARDIAO && typeof window.GUARDIAO.tick === "function") window.GUARDIAO.tick(dt); if(window.ORDEM && typeof window.ORDEM.tick === "function") window.ORDEM.tick(dt); if(window.UTERO && typeof window.UTERO.tick === "function") window.UTERO.tick(dt); if(window.FORCA && typeof window.FORCA.tick === "function") window.FORCA.tick(dt); // 2) Mundo (clima, NPCs, ecologia…) – se existir função global if(window.WORLD && typeof window.WORLD.tick === "function") window.WORLD.tick(dt); // 3) Estados fisiológicos (já existem) — avançam mesmo sem input if(window.tickStates) window.tickStates(dt); // 4) Narrativa: deixa para quando eventos gerarem "dirty flag" if(window.NARRATIVE && typeof window.NARRATIVE.maybeRender === "function") window.NARRATIVE.maybeRender(); // 5) Tempo do mundo worldTime = new Date(worldTime.getTime() + dt*1000); } function loop(now){ const delta = now - last; last = now; acc += delta; while(acc >= FRAME_MS){ step(FRAME_MS/1000); acc -= FRAME_MS; frames++; } // FPS meter if(now - lastSec >= 1000){ fps = frames; frames = 0; lastSec = now; const hh = String(worldTime.getHours()).padStart(2,'0'); const mm = String(worldTime.getMinutes()).padStart(2,'0'); const ss = String(worldTime.getSeconds()).padStart(2,'0'); if(fpsPanel) fpsPanel.textContent = `FPS: ${fps} | Tempo: ${hh}:${mm}:${ss}`; } requestAnimationFrame(loop); } requestAnimationFrame(loop); // ===== PWA: Manifest + Service Worker (inline via Blob) ===== function createIcon(size){ const c = document.createElement('canvas'); c.width=c.height=size; const ctx = c.getContext('2d'); ctx.fillStyle = '#0b0e16'; ctx.fillRect(0,0,size,size); ctx.strokeStyle = '#7dffcb'; ctx.lineWidth = size*0.06; ctx.strokeRect(size*0.08,size*0.08,size*0.84,size*0.84); ctx.fillStyle = '#cfe1ff'; ctx.font = `${Math.floor(size*0.22)}px serif`; ctx.fillText('CORPO', size*0.12, size*0.56); return c.toDataURL('image/png'); } const icons = [192, 256, 512].map(sz=>({src:createIcon(sz), sizes:`${sz}x${sz}`, type:"image/png", purpose:"any maskable"})); const manifest = { name: "Corpo", short_name: "Corpo", start_url: ".", scope: ".", display: "standalone", background_color: "#0b0e16", theme_color: "#0b0e16", icons }; const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'}); const manifestURL = URL.createObjectURL(manifestBlob); const link = document.createElement('link'); link.rel='manifest'; link.href=manifestURL; document.head.appendChild(link); // iOS meta const metaIOS = document.createElement('meta'); metaIOS.name="apple-mobile-web-app-capable"; metaIOS.content="yes"; document.head.appendChild(metaIOS); const metaIOS2 = document.createElement('meta'); metaIOS2.name="apple-mobile-web-app-status-bar-style"; metaIOS2.content="black-translucent"; document.head.appendChild(metaIOS2); const linkIOS = document.createElement('link'); linkIOS.rel="apple-touch-icon"; linkIOS.href=icons[1].src; document.head.appendChild(linkIOS); // Service Worker const swCode = ` const CACHE = 'corpo-v24'; self.addEventListener('install', e=>{ e.waitUntil((async()=>{ const c = await caches.open(CACHE); // single-file: cache a própria shell (index) via fallback await c.put('/', new Response('<!DOCTYPE html><meta http-equiv="refresh" content="0">')); })()); self.skipWaiting(); }); self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); }); self.addEventListener('fetch', e=>{ // Network-first for same-origin; fallback to cache e.respondWith((async()=>{ try{ const res = await fetch(e.request); return res; }catch(err){ const c = await caches.open(CACHE); const match = await c.match(e.request) || await c.match('/'); return match || Response.error(); } })()); }); `; const swURL = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'})); if('serviceWorker' in navigator){ navigator.serviceWorker.register(swURL).catch(console.warn); } // ===== Install prompt (Android) & iOS hint ===== const installUI = document.getElementById('installPWA'); const btnInstall = document.getElementById('btnInstall'); let deferredPrompt = null; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installUI.style.display = 'block'; }); if(btnInstall){ btnInstall.addEventListener('click', async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; installUI.style.display = 'none'; deferredPrompt = null; }else{ alert('No Android prompt. No iOS? Use "Compartilhar → Adicionar à Tela de Início".'); } }); } // No iOS: mostramos banner com instrução básica (Safari → compartilhar → Adic. à Tela Inicial) const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent); if(isIOS){ installUI.style.display = 'block'; installUI.firstChild.textContent = 'No iOS: Compartilhar → Adicionar à Tela de Início'; } console.log("v24 PWA: loop 30FPS, manifest+SW inline, painel FPS/Clock, install prompt");
})();
</script><div id="fpsPanel">FPS: -- | Tempo: --:--:--</div><div id="installPWA">Instalar CORPO como app? <button id="btnInstall">Instalar</button></div><script>
(function(){ // ===== NPC extras ===== // Adicionar Corvo, Renato, Alace com avatares placeholders e relações const AV_MORE = { "Corvo": { key:"AV_CORVO", base:"#12131b", fg:"#ffffff", accent:"#61dafb" }, "Renato":{ key:"AV_RENATO", base:"#14131b", fg:"#ffffff", accent:"#ffa94d" }, "Alace": { key:"AV_ALACE", base:"#15141b", fg:"#ffffff", accent:"#7bd389" } }; async function genAvatarCanvasAdv(name, spec){ const c = document.createElement("canvas"); c.width=600; c.height=600; const ctx = c.getContext("2d"); ctx.fillStyle = spec.base; ctx.fillRect(0,0,c.width,c.height); ctx.strokeStyle = spec.accent; ctx.lineWidth=6; ctx.strokeRect(20,20,560,560); ctx.fillStyle = spec.fg; ctx.font="bold 34px serif"; ctx.fillText(name, 26, 54); // traços mangá extra ctx.fillStyle = "#e5e9ff"; ctx.beginPath(); ctx.arc(300,300,170,0,Math.PI*2); ctx.fill(); ctx.fillStyle = "#0b0e16"; ctx.beginPath(); ctx.arc(260,270,12,0,Math.PI*2); ctx.arc(340,270,12,0,Math.PI*2); ctx.fill(); ctx.strokeStyle = spec.accent; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(300,350,60,0,Math.PI); ctx.stroke(); ctx.font="16px serif"; ctx.fillStyle = spec.fg; ctx.fillText("mangá — placeholder", 26, 84); return c.toDataURL("image/png"); } async function precacheMore(){ for(const n in AV_MORE){ const spec = AV_MORE[n]; const dataURL = await genAvatarCanvasAdv(n, spec); await window.pushWorldImage(spec.key, dataURL); } } precacheMore(); // Injetar NPCs se ainda não existir const NPC = window.NPC = window.NPC || []; function addNPC(n){ if(!NPC.find(x=>x.id===n.id)) NPC.push(n); } addNPC({id:"P0005", nome:"Corvo", relacoes:["Tigre","Renato"], afinidade:64, beleza:58, sex_appeal:60, avatar:"AV_CORVO"}); addNPC({id:"P0006", nome:"Renato", relacoes:["Corvo","Tigre"], afinidade:55, beleza:62, sex_appeal:57, avatar:"AV_RENATO"}); addNPC({id:"P0007", nome:"Alace", relacoes:["Tigre"], afinidade:68, beleza:61, sex_appeal:59, avatar:"AV_ALACE"}); // ===== Áudio por distrito e biomas ===== const ECO = window.ECO || {}; ECO.ambienceDistrict = function(distrito){ // Mapeia distrito a "cor sonora" const map = { D1:{bioma:"cidade", base:130}, D2:{bioma:"costa", base:140}, D3:{bioma:"floresta", base:95}, D4:{bioma:"cidade", base:115} }; const cfg = map[distrito] || {bioma:"cidade", base:120}; if(ECO.ambience) ECO.ambience(cfg.bioma); // beep sutil para transição if(ECO.click) ECO.click(); const badge = document.getElementById("audioStatus"); if(badge) badge.textContent = "ambiente: "+cfg.bioma+" ("+distrito+")"; }; window.ECO = ECO; // Hook com motor: se existir onDistrictChanged, usa; senão exponha função global if(window.onDistrictChanged){ window.onDistrictChanged((d)=> ECO.ambienceDistrict(d)); }else{ window.setDistrict = (d)=> ECO.ambienceDistrict(d); } // ===== Autosave a cada 2 escolhas ===== const SAVE = window.SAVE = window.SAVE || {}; SAVE.counter = 0; SAVE.key = "CORPO_SAVE_MAIN"; SAVE.snapshot = function(){ // coleta estado mínimo seguro (sem dados sensíveis) const state = { ver: 23, char: window.CURRENT_CHAR || null, states: window.STATES || null, time: Date.now() }; localStorage.setItem(SAVE.key, JSON.stringify(state)); const b = document.getElementById("saveBadge"); if(b) b.textContent = "💾 Autosave: "+(new Date(state.time)).toLocaleString(); }; SAVE.bump = function(){ SAVE.counter++; if(SAVE.counter % 2 === 0) SAVE.snapshot(); }; // Integra ao motor se houver addChoiceHook if(window.addChoiceHook){ window.addChoiceHook(()=> SAVE.bump()); } // ===== Saudações e seleção dinâmica ===== const welcome = document.getElementById("welcomeBanner"); if(welcome){ let t = "ola meu nobre, oque tu é do Tigre?"; if(window.CURRENT_CHAR) t = "Conectado: "+window.CURRENT_CHAR+" — bom jogo!"; welcome.textContent = t; } // ===== Peças utilitárias ===== // Exemplo: setar distrito inicial caso o motor não faça if(!window.CURRENT_DISTRICT) window.CURRENT_DISTRICT = "D1"; ECO.ambienceDistrict(window.CURRENT_DISTRICT); console.log("v23: NPCs extras, som por distrito, autosave/2, saudação dinâmica");
})();
</script><div id="welcomeBanner">ola meu nobre, oque tu é do Tigre?</div><div id="saveBadge">💾 Autosave: aguardando…</div><script>
(function(){ // ===== MIXER DE ÁUDIO (WebAudio) ===== let AC = null, master = null; const audioState = { running:false, ambient:null, sfx:null }; function audioInit(){ if(AC) return; AC = new (window.AudioContext||window.webkitAudioContext)(); master = AC.createGain(); master.gain.value = 0.4; master.connect(AC.destination); window.addEventListener("click", ()=>{ if(AC.state==="suspended") AC.resume(); }, {once:true}); } function makeNoise(freq=220, type="sine", gain=0.02, attack=0.01, release=1.5){ audioInit(); const o = AC.createOscillator(); o.type = type; o.frequency.value = freq; const g = AC.createGain(); g.gain.value = 0.0; o.connect(g); g.connect(master); const t = AC.currentTime; g.gain.linearRampToValueAtTime(gain, t+attack); g.gain.exponentialRampToValueAtTime(0.0001, t+release); o.start(); o.stop(t+release+0.05); } const ECO = window.ECO = window.ECO || {}; ECO.click = ()=> makeNoise(880,"square",0.02,0.01,0.12); ECO.ambience = function(kind="cidade"){ audioInit(); if(audioState.ambient) audioState.ambient.stop(); const t = AC.currentTime; // ruído ambiente com LFO: simples e leve const noise = AC.createOscillator(); noise.type="triangle"; noise.frequency.value = (kind==="costa"?140:(kind==="floresta"?90:120)); const g = AC.createGain(); g.gain.value = 0.0; const lfo = AC.createOscillator(); lfo.type="sine"; lfo.frequency.value=0.15; const lfoGain = AC.createGain(); lfoGain.gain.value = 0.15; lfo.connect(lfoGain); lfoGain.connect(g.gain); noise.connect(g); g.connect(master); g.gain.setValueAtTime(0.001, t); g.gain.exponentialRampToValueAtTime(0.08, t+2.0); noise.start(); lfo.start(); audioState.ambient = noise; document.getElementById("audioStatus").textContent = "ambiente: "+kind; }; ECO.sfx = { zumbi: ()=>makeNoise(110,"sawtooth",0.05,0.02,0.6), carro: ()=>makeNoise(200,"sine",0.03,0.01,0.8), cachorro: ()=>makeNoise(500,"triangle",0.02,0.01,0.3) }; window.ECO = ECO; // ===== AVATARES (mangá-style placeholders) + pré-cache ===== const AV = { "Tigre": { key:"AV_TIGRE", base:"#0f0f16", fg:"#ffffff", accent:"#ff375f" }, "Carol": { key:"AV_CAROL", base:"#101418", fg:"#ffffff", accent:"#7dffcb" }, "Filho_1": { key:"AV_FILHO1", base:"#0d1017", fg:"#ffffff", accent:"#ffd166" }, "Filha": { key:"AV_FILHA", base:"#0d0f18", fg:"#ffffff", accent:"#a47cff" } }; async function genAvatarCanvas(name, spec){ const c = document.createElement("canvas"); c.width=600; c.height=600; const ctx = c.getContext("2d"); ctx.fillStyle = spec.base; ctx.fillRect(0,0,c.width,c.height); // estilo mangá simples ctx.fillStyle = spec.fg; ctx.font="bold 36px serif"; ctx.fillText(name, 24, 56); ctx.strokeStyle = spec.accent; ctx.lineWidth=6; ctx.strokeRect(18,18, c.width-36, c.height-36); ctx.font="18px serif"; ctx.fillText("mangá — placeholder", 24, 86); // rosto minimalista ctx.beginPath(); ctx.arc(300,310,160,0,Math.PI*2); ctx.strokeStyle="#e5e9ff"; ctx.lineWidth=3; ctx.stroke(); ctx.fillStyle = "#e5e9ff"; ctx.beginPath(); ctx.arc(250,280,10,0,Math.PI*2); ctx.arc(350,280,10,0,Math.PI*2); ctx.fill(); ctx.strokeStyle = spec.accent; ctx.beginPath(); ctx.arc(300,350,50,0,Math.PI); ctx.stroke(); return c.toDataURL("image/png"); } async function precacheAvatars(){ for(const n in AV){ const spec = AV[n]; const dataURL = await genAvatarCanvas(n, spec); await window.pushWorldImage(spec.key, dataURL); } } precacheAvatars(); // ===== NPC CATALOG ===== const NPC = window.NPC = window.NPC || []; // Núcleo base (puxa do CÉREBRO se existir; aqui, garantimos alguns) function seedNPCBase(){ // Evitar duplicar if(NPC.find(n=>n.id==="P0001")) return; NPC.push( {id:"P0001", nome:"Tigre", relacoes:["Carol","Filho_1","Filha"], afinidade:80, beleza:78, sex_appeal:85, avatar:"AV_TIGRE"}, {id:"P0002", nome:"Carol", relacoes:["Tigre","Filho_1","Filha"], afinidade:82, beleza:88, sex_appeal:90, avatar:"AV_CAROL"}, {id:"P0003", nome:"Filho_1", relacoes:["Tigre","Carol","Filha"], afinidade:60, beleza:65, sex_appeal:55, avatar:"AV_FILHO1"}, {id:"P0004", nome:"Filha", relacoes:["Tigre","Carol","Filho_1"], afinidade:70, beleza:72, sex_appeal:68, avatar:"AV_FILHA"} ); } seedNPCBase(); function renderNPCGrid(list){ const grid = document.getElementById("npcGrid"); grid.innerHTML = ""; list.forEach(n=>{ const card = document.createElement("div"); card.className="npcCard"; const img = document.createElement("img"); img.loading="lazy"; img.alt=n.nome; // pegar do cache (async ()=>{ const url = await IMG_CACHE.getOrCacheImage(n.avatar, async ()=> await genAvatarCanvas(n.nome, AV[n.nome]||{base:"#0f0f16",fg:"#fff",accent:"#7dffcb"})); img.src = url; })(); const meta = document.createElement("div"); meta.className="npcMeta"; meta.innerHTML = `<div><b>${n.nome}</b><span class="badge">ID ${n.id}</span></div><div>afinidade: ${n.afinidade} | beleza: ${n.beleza} | sex-appeal: ${n.sex_appeal}</div><div>laços: ${n.relacoes.join(", ")}</div>`; const row = document.createElement("div"); row.className="row"; const btnPlay = document.createElement("button"); btnPlay.className="btn btnTiny"; btnPlay.textContent="Jogar"; btnPlay.onclick = ()=> window.selectCharacterByName(n.nome); row.appendChild(document.createElement("div")); row.appendChild(btnPlay); card.appendChild(img); card.appendChild(meta); card.appendChild(row); grid.appendChild(card); }); } // Botões do catálogo const btnNPC = document.getElementById("btnNPC"); const npcCatalog = document.getElementById("npcCatalog"); const btnCloseNPC = document.getElementById("btnCloseNPC"); const npcSearch = document.getElementById("npcSearch"); btnNPC.onclick = ()=>{ renderNPCGrid(NPC); npcCatalog.style.display="block"; }; btnCloseNPC.onclick = ()=>{ npcCatalog.style.display="none"; }; npcSearch.oninput = ()=>{ const q = npcSearch.value.toLowerCase().trim(); const list = NPC.filter(n=> n.nome.toLowerCase().includes(q) || n.id.toLowerCase().includes(q)); renderNPCGrid(list); }; // ===== ESTADOS FISIOLÓGICOS ===== const STATES = window.STATES = { fome:0.2, sede:0.2, sono:0.1, dor:0.0, stress:0.1 }; const STATE_DECAY = { fome:+0.0006, sede:+0.0008, sono:+0.0005, stress:+0.0006 }; function clamp01(x){ return Math.max(0, Math.min(1, x)); } function tickStates(dt){ for(const k in STATE_DECAY){ STATES[k] = clamp01(STATES[k] + STATE_DECAY[k]*dt); } // substâncias podem afetar if(window.STAT){ STATES.stress = clamp01(STATES.stress - (window.STAT.Calma||0)*0.002*dt + (window.STAT.Ansiedade||0)*0.002*dt); STATES.dor = clamp01(STATES.dor + (window.STAT.Dor||0)*0.001*dt); } renderStates(); } const statesBar = document.getElementById("statesBar"); function renderStates(){ statesBar.innerHTML = ""; for(const k of ["fome","sede","sono","dor","stress"]){ const v = Math.round(STATES[k]*100); const pill = document.createElement("div"); pill.className="statePill"; pill.textContent = k.toUpperCase()+": "+v+"%"; statesBar.appendChild(pill); } } renderStates(); let lastT = performance.now(); function loop(){ const now = performance.now(); const dt = (now-lastT)/1000; lastT = now; tickStates(dt); requestAnimationFrame(loop); } requestAnimationFrame(loop); // ===== SELEÇÃO INTELIGENTE POR TEXTO ===== // entende "sou a mulher", "sou o filho do Tigre", "quero ser Carol", "jogar com Filha" function normalize(t){ return (t||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); } window.selectCharacterByName = function(name){ const target = NPC.find(n=> normalize(n.nome)===normalize(name)); if(target){ // conecta ao motor existente if(window.startGameAs) window.startGameAs(target.nome); else alert("Seleção: "+target.nome); npcCatalog.style.display="none"; } }; // hook no input inicial, se existir const selInput = document.getElementById("inputSelecao"); if(selInput){ selInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ const t = normalize(selInput.value); let chosen = null; if(/mulher|esposa/.test(t)) chosen = "Carol"; else if(/filho/.test(t)) chosen = "Filho_1"; else if(/filha/.test(t)) chosen = "Filha"; else if(/tigre|carol|filha|filho/.test(t)){ if(/tigre/.test(t)) chosen = "Tigre"; if(/carol/.test(t)) chosen = "Carol"; if(/filha/.test(t)) chosen = "Filha"; if(/filho/.test(t)) chosen = "Filho_1"; }else if(/criar|novo|personagem/.test(t)){ // o motor já lida com criação personalizada if(window.requestCreateCharacter) window.requestCreateCharacter(t); } if(chosen) window.selectCharacterByName(chosen); } }); } // ===== INTEGRAÇÃO AMBIENTE AO MARCO 0 ===== // Quando o jogo entrar no mapa do D1→D4, ligamos ambiência if(window.onSceneEntered){ window.onSceneEntered((scene)=>{ if(scene&&scene.bioma) ECO.ambience(scene.bioma); }); }else{ // fallback: inicia com cidade ECO.ambience("cidade"); } // v22 ready console.log("v22 onefile: avatars, catalogo, audio, estados, seleção inteligente"); document.getElementById("audioStatus").textContent = "ambiente: cidade";
})();
</script><div id="npcCatalog"><div class="row"><div style="font-weight:bold">Catálogo de Personagens</div><div><input id="npcSearch" placeholder="buscar..." class="input" style="width:220px"><button id="btnCloseNPC" class="btn">Fechar</button></div></div><div id="npcGrid"></div></div><div id="statesBar"></div><div id="audioBadge">🎧 Áudio: <span id="audioStatus">parado</span></div></html>
